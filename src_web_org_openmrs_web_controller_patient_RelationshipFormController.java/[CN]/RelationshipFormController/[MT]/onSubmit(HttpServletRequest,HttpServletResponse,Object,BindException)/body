{
  HttpSession httpSession=request.getSession();
  Context context=(Context)httpSession.getAttribute(WebConstants.OPENMRS_CONTEXT_HTTPSESSION_ATTR);
  String view=getFormView();
  if (context != null && context.isAuthenticated()) {
    Person person=(Person)obj;
    PatientService ps=context.getPatientService();
    AdministrationService as=context.getAdministrationService();
    String action=request.getParameter("action");
    if (action == null)     action="";
    MessageSourceAccessor msa=getMessageSourceAccessor();
    if (action.equals(msa.getMessage("Relationship.save"))) {
      String[] relTypes=request.getParameterValues("relationshipType");
      String[] patients=request.getParameterValues("patientId");
      log.debug("patients: ");
      for (int x=0; x < patients.length; x++) {
        log.debug("#" + patients[x]);
      }
      for (int x=0; x < relTypes.length; x++) {
        Relationship r=new Relationship();
        log.error("relType: " + relTypes[x]);
        log.error("patient: " + patients[x + 1]);
        if (relTypes[x].equals("") && !patients[x].equals("")) {
          errors.reject("relationshipType","error.null");
          return showForm(request,response,errors);
        }
 else         if (!relTypes[x].equals("") && !patients[x + 1].equals("")) {
          r.setRelationship(ps.getRelationshipType(Integer.valueOf(relTypes[x])));
          Patient patient=ps.getPatient(Integer.valueOf(patients[x + 1]));
          log.debug("patient: " + patient);
          Person relative=patient.getPerson();
          log.debug("relative: " + relative);
          if (relative == null)           relative=as.getPerson(patient);
          log.debug("relative: " + relative);
          if (relative == null)           relative=new Person(patient);
          log.debug("relative: " + relative);
          r.setRelative(relative);
          r.setPerson(person);
          as.updatePerson(person);
          as.createRelationship(r);
        }
      }
    }
 else     if (action.equals(msa.getMessage("Relationship.void"))) {
      String[] relIds=request.getParameterValues("relationshipId");
    }
 else     if (action.equals(msa.getMessage("Relationship.unvoid"))) {
      String[] relIds=request.getParameterValues("relationshipId");
      for (      String id : relIds) {
        Relationship r=ps.getRelationship(Integer.valueOf(id));
        as.unvoidRelationship(r);
      }
    }
    view=getSuccessView();
    httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,msa.getMessage("Relationship.saved"));
  }
  return new ModelAndView(new RedirectView(view));
}
