{
  HttpSession httpSession=request.getSession();
  Context context=(Context)httpSession.getAttribute(WebConstants.OPENMRS_CONTEXT_HTTPSESSION_ATTR);
  Person person=null;
  if (context != null && context.isAuthenticated()) {
    PatientService ps=context.getPatientService();
    AdministrationService as=context.getAdministrationService();
    UserService us=context.getUserService();
    String personId=request.getParameter("personId");
    String patientId=request.getParameter("patientId");
    String userId=request.getParameter("userId");
    if (personId != null)     person=as.getPerson(Integer.valueOf(personId));
 else     if (patientId != null) {
      Patient pat=ps.getPatient(Integer.valueOf(patientId));
      if (pat.getPerson() == null)       person=new Person(pat);
 else       person=pat.getPerson();
    }
 else     if (userId != null) {
      User user=us.getUser(Integer.valueOf(userId));
      if (user.getPerson() == null)       person=new Person(user);
 else       person=user.getPerson();
    }
  }
  if (person == null)   person=new Person();
  return person;
}
