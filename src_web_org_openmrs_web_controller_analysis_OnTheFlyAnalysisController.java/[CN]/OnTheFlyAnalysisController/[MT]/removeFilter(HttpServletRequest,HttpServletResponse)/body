{
  HttpSession httpSession=request.getSession();
  if (!Context.isAuthenticated()) {
    httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"auth.session.expired");
    response.sendRedirect(request.getContextPath() + "/logout");
    return null;
  }
  PatientAnalysis analysis=Context.getPatientSetService().getMyPatientAnalysis();
  if (analysis != null) {
    if ("true".equals(request.getParameter("remove_all_filters"))) {
      analysis.getPatientFilters().clear();
    }
    String keyToRemove=request.getParameter("patient_filter_key");
    log.debug("removing filter " + keyToRemove);
    if (keyToRemove != null) {
      PatientFilter pf=analysis.removeFilter(keyToRemove);
      log.debug("returns " + pf);
    }
  }
  return new ModelAndView(new RedirectView("analysis.list?viewMethod=" + request.getParameter("viewMethod")));
}
