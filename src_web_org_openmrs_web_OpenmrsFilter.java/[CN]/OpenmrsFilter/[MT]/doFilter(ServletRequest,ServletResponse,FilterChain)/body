{
  HttpServletRequest httpRequest=(HttpServletRequest)request;
  HttpSession httpSession=httpRequest.getSession();
  UserContext userContext=null;
  boolean initialRequest=false;
  Object val=httpRequest.getAttribute(WebConstants.INIT_REQ_UNIQUE_ID);
  initialRequest=(val == null);
  log.debug("initial Request? " + initialRequest);
  log.debug("requestURI" + httpRequest.getRequestURI());
  log.debug("requestURL" + httpRequest.getRequestURL());
  log.debug("request path info" + httpRequest.getPathInfo());
  if (initialRequest)   httpRequest.setAttribute(WebConstants.INIT_REQ_UNIQUE_ID,String.valueOf(new Date().getTime()));
  if (initialRequest == true) {
    userContext=(UserContext)httpSession.getAttribute(WebConstants.OPENMRS_USER_CONTEXT_HTTPSESSION_ATTR);
    if (userContext == null) {
      userContext=new UserContext();
      httpSession.setAttribute(WebConstants.OPENMRS_USER_CONTEXT_HTTPSESSION_ATTR,userContext);
    }
    log.info("Set user context " + userContext + " as attribute on session");
    Context.setUserContext(userContext);
  }
  log.debug("before doFilter");
  chain.doFilter(request,response);
  httpSession.setAttribute(WebConstants.OPENMRS_USER_CONTEXT_HTTPSESSION_ATTR,userContext);
  if (initialRequest == true) {
    Context.clearUserContext();
  }
  log.debug("after doFilter");
}
