{
  HttpSession httpSession=request.getSession();
  String view=getFormView();
  try {
    Context.addProxyPrivilege(PrivilegeConstants.VIEW_USERS);
    Context.addProxyPrivilege(PrivilegeConstants.VIEW_PATIENTS);
    if (Context.isAuthenticated()) {
      Encounter encounter=(Encounter)obj;
      if (request.getParameter("patientId") != null) {
        encounter.setPatient(Context.getPatientService().getPatient(Integer.valueOf(request.getParameter("patientId"))));
      }
      if (encounter.isVoided() && encounter.getVoidedBy() == null) {
        Context.getEncounterService().voidEncounter(encounter,encounter.getVoidReason());
      }
 else       if (!encounter.isVoided() && encounter.getVoidedBy() != null) {
        Context.getEncounterService().unvoidEncounter(encounter);
      }
 else {
        Context.getEncounterService().saveEncounter(encounter);
      }
      view=getSuccessView();
      view=view + "?encounterId=" + encounter.getEncounterId();
      httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Encounter.saved");
    }
  }
 catch (  APIException e) {
    log.error("Error while trying to save the encounter",e);
    httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"Encounter.cannot.save");
    errors.reject("encounter","Encounter.cannot.save");
    return showForm(request,response,errors);
  }
 finally {
    Context.removeProxyPrivilege(PrivilegeConstants.VIEW_USERS);
    Context.removeProxyPrivilege(PrivilegeConstants.VIEW_PATIENTS);
  }
  return new ModelAndView(new RedirectView(view));
}
