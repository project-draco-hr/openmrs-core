{
  Map<String,Module> publicImportsMap=new WeakHashMap<String,Module>();
  for (  String moduleId : ModuleConstants.REQUIRED_MODULES.keySet()) {
    Module module=ModuleFactory.getModuleById(moduleId);
    if (module == null && !ModuleUtil.ignoreRequiredModules()) {
      log.error("Unable to find an openmrs required loaded module with id: " + moduleId);
      throw new APIException("Should not be here.  All 'required' modules by the api should be started and their classloaders should be available");
    }
    if (module != null && !moduleId.equals(this.getModule().getModuleId())) {
      publicImportsMap.put(moduleId,module);
    }
  }
  for (  String requiredPackage : getModule().getRequiredModules()) {
    Module requiredModule=ModuleFactory.getModuleByPackage(requiredPackage);
    if (ModuleFactory.isModuleStarted(requiredModule)) {
      publicImportsMap.put(requiredModule.getModuleId(),requiredModule);
    }
  }
  requiredModules=(Module[])publicImportsMap.values().toArray(new Module[publicImportsMap.size()]);
}
