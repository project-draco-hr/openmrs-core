{
  if (log.isDebugEnabled())   log.debug("Calling authorization advice before " + method.getName());
  User user=Context.getAuthenticatedUser();
  if (log.isDebugEnabled()) {
    log.debug("User " + user);
    if (user != null)     log.debug("has roles " + user.getAllRoles());
  }
  AuthorizedAnnotationAttributes attributes=new AuthorizedAnnotationAttributes();
  Collection<String> attrs=attributes.getAttributes(method);
  boolean requireAll=attributes.getRequireAll(method);
  if (attrs.size() > 0) {
    for (    String privilege : attrs) {
      if (privilege == null || privilege.length() < 1)       return;
      if (log.isDebugEnabled())       log.debug("User has privilege " + privilege + "? "+ Context.hasPrivilege(privilege));
      if (Context.hasPrivilege(privilege)) {
        if (requireAll == false) {
          return;
        }
      }
 else       if (requireAll == true) {
        throwUnauthorized(user,method,privilege);
      }
    }
    if (requireAll == false) {
      throwUnauthorized(user,method,attrs);
    }
  }
 else   if (attributes.hasAuthorizedAnnotation(method)) {
    if (Context.isAuthenticated() == false)     throwUnauthorized(user,method);
  }
}
