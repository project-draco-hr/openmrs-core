{
  HttpSession httpSession=request.getSession();
  String view=getFormView();
  if (Context.isAuthenticated()) {
    DrugOrder order=(DrugOrder)obj;
    Drug thisDrug=order.getDrug();
    Concept thisConcept=thisDrug.getConcept();
    order.setConcept(thisConcept);
    order.setOrderType(new OrderType(new Integer(2)));
    Patient thisPatient=null;
    if (order.getEncounter() == null) {
      Integer patientId=ServletRequestUtils.getIntParameter(request,"patientId");
      if (patientId != null) {
        thisPatient=Context.getPatientService().getPatient(patientId);
      }
    }
    order.setPatient(thisPatient);
    if (order.getDateCreated() == null)     order.setDateCreated(new Date());
    if (order.getVoided() == null)     order.setVoided(new Boolean(false));
    Context.getOrderService().updateOrder(order);
    view=getSuccessView();
    httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Order.drug.saved");
  }
  return new ModelAndView(new RedirectView(view));
}
