{
  if (log.isDebugEnabled())   log.debug("Calling authorization advice before " + method.getName());
  User user=Context.getAuthenticatedUser();
  if (log.isDebugEnabled()) {
    log.debug("User " + user);
    if (user != null)     log.debug("has roles " + user.getAllRoles());
  }
  AuthorizedAnnotationAttributes attributes=new AuthorizedAnnotationAttributes();
  Collection<String> privileges=attributes.getAttributes(method);
  boolean requireAll=attributes.getRequireAll(method);
  if (!privileges.isEmpty()) {
    for (    String privilege : privileges) {
      if (privilege == null || privilege.isEmpty())       return;
      if (log.isDebugEnabled())       log.debug("User has privilege " + privilege + "? "+ Context.hasPrivilege(privilege));
      if (Context.hasPrivilege(privilege)) {
        notifyPrivilegeListeners(user,privilege,true);
        if (!requireAll) {
          return;
        }
      }
 else {
        notifyPrivilegeListeners(user,privilege,false);
        if (requireAll) {
          throwUnauthorized(user,method,privilege);
        }
      }
    }
    if (requireAll == false) {
      throwUnauthorized(user,method,privileges);
    }
  }
 else   if (attributes.hasAuthorizedAnnotation(method)) {
    if (Context.isAuthenticated() == false)     throwUnauthorized(user,method);
  }
}
