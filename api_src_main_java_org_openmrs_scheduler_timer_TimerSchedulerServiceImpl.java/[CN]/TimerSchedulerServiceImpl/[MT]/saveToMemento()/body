{
  Set<TaskDefinition> tasks=new HashSet<TaskDefinition>();
  TimerSchedulerMemento memento=new TimerSchedulerMemento(tasks);
  try {
    if (Context.getAuthenticatedUser() == null) {
      Daemon.setRunningAsDaemonUser(true);
    }
    for (    TaskDefinition task : getScheduledTasks()) {
      tasks.add(task);
      try {
        shutdownTask(task);
      }
 catch (      SchedulerException e) {
        log.debug("Failed to stop task while saving memento " + task.getName(),e);
      }
    }
    memento.saveErrorTasks();
  }
  finally {
    Daemon.setRunningAsDaemonUser(false);
  }
  return memento;
}
