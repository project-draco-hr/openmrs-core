{
  String redirect=request.getParameter("redirect");
  if (redirect == null || redirect.equals("")) {
    redirect=request.getContextPath();
  }
 else   if (redirect.contains("login.")) {
    log.debug("Redirect contains 'login.', redirecting to main page");
    redirect=request.getContextPath();
  }
 else   if (!redirect.startsWith(request.getContextPath())) {
    log.debug("redirect is outside of openmrs, redirecting to main page");
    redirect=request.getContextPath();
  }
 else   if (redirect.endsWith(WebConstants.SETUP_PAGE_URL)) {
    log.debug("redirect is back to the setup page because this is their first ever login");
    redirect=request.getContextPath();
  }
 else   if (redirect.contains("/options.form") || redirect.contains("/changePassword.form") || redirect.contains("/forgotPassword.form")) {
    log.debug("The user was on a page for setting/changing passwords. Send them to the homepage to reduce confusion");
    redirect=request.getContextPath();
  }
  log.debug("Going to use redirect: '" + redirect + "'");
  return redirect;
}
