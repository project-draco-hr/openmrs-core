{
  initializeInMemoryDatabase();
  executeDataSet("org/openmrs/reporting/include/PatientFilterTest.xml");
  authenticate();
  EvaluationContext ec=new EvaluationContext();
  CachingPatientFilter maleFilter=new PatientCharacteristicFilter("M",null,null);
  CachingPatientFilter femaleFilter=new PatientCharacteristicFilter("F",null,null);
  String maleKey=maleFilter.getCacheKey();
  String femaleKey=femaleFilter.getCacheKey();
  assertNull("Cache should not have male filter yet",ec.getFromCache(maleKey));
  Cohort males=maleFilter.filter(null,ec);
  assertNotNull("Cache should have male filter now",ec.getFromCache(maleKey));
  assertNull("Cache should not have female filter",ec.getFromCache(femaleKey));
  Cohort malesAgain=maleFilter.filter(null,ec);
  assertEquals("Uncached and cached runs should be equals",males.size(),malesAgain.size());
  ec.setBaseCohort(males);
  assertEquals("Cache should have been automatically cleared",0,ec.getCache().size());
}
