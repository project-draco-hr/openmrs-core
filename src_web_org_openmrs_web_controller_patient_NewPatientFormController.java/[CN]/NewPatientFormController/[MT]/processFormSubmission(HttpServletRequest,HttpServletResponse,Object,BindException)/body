{
  newIdentifiers=new HashSet<PatientIdentifier>();
  ShortPatientModel shortPatient=(ShortPatientModel)obj;
  log.debug("\nNOW GOING THROUGH PROCESSFORMSUBMISSION METHOD.......................................\n\n");
  if (Context.isAuthenticated()) {
    PatientService ps=Context.getPatientService();
    MessageSourceAccessor msa=getMessageSourceAccessor();
    String action=request.getParameter("action");
    if (action == null || action.equals(msa.getMessage("general.save"))) {
      String[] identifiers=request.getParameterValues("identifier");
      String[] types=request.getParameterValues("identifierType");
      String[] locs=request.getParameterValues("location");
      pref=request.getParameter("preferred");
      if (pref == null)       pref="";
      if (log.isDebugEnabled()) {
        log.debug("identifiers: " + identifiers);
        if (identifiers != null) {
          for (          String s : identifiers)           log.debug(s);
        }
        log.debug("types: " + types);
        if (types != null) {
          for (          String s : types)           log.debug(s);
        }
        log.debug("locations: " + locs);
        if (locs != null) {
          for (          String s : locs)           log.debug(s);
        }
        log.debug("preferred: " + pref);
      }
      if (identifiers != null) {
        for (int i=0; i < identifiers.length; i++) {
          String id=identifiers[i].trim();
          String[] args={id};
          if (id.length() > 0) {
            PatientIdentifierType pit=null;
            if (types[i] == null || types[i].equals("")) {
              String msg=getMessageSourceAccessor().getMessage("PatientIdentifier.identifierType.null",args);
              errors.reject(msg);
            }
 else             pit=ps.getPatientIdentifierType(Integer.valueOf(types[i]));
            Location loc=null;
            if (locs[i] == null || locs[i].equals("")) {
              String msg=getMessageSourceAccessor().getMessage("PatientIdentifier.location.null",args);
              errors.reject(msg);
            }
 else             loc=Context.getLocationService().getLocation(Integer.valueOf(locs[i]));
            PatientIdentifier pi=new PatientIdentifier(id,pit,loc);
            pi.setPreferred(pref.equals(id + types[i]));
            if (newIdentifiers.contains(pi))             newIdentifiers.remove(pi);
            newIdentifiers.add(pi);
            if (log.isDebugEnabled()) {
              log.debug("Creating patient identifier with identifier: " + id);
              log.debug("and type: " + types[i]);
              log.debug("and location: " + locs[i]);
            }
          }
        }
      }
    }
  }
  return onSubmit(request,response,shortPatient,errors);
}
