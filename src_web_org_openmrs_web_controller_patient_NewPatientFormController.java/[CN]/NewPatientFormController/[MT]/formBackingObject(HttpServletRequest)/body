{
  HttpSession httpSession=request.getSession();
  Context context=(Context)httpSession.getAttribute(WebConstants.OPENMRS_CONTEXT_HTTPSESSION_ATTR);
  Patient p=null;
  if (context == null || !context.isAuthenticated()) {
  }
 else {
    FormEntryService ps=context.getFormEntryService();
    String patientId=request.getParameter("pId");
    if (patientId != null && !patientId.equals("")) {
      p=ps.getPatient(Integer.valueOf(patientId));
    }
  }
  PatientListItem patient=new PatientListItem(p);
  String name=request.getParameter("name");
  if (p == null && name != null) {
    String firstName=name;
    String middleName="";
    String lastName="";
    if (name.contains(",")) {
      String[] names=name.split(", ");
      String[] firstNames=names[1].split(" ");
      if (firstNames.length == 2) {
        lastName=names[0];
        firstName=firstNames[0];
        middleName=firstNames[1];
      }
 else {
        firstName=names[1];
        lastName=names[2];
      }
    }
 else     if (name.contains(" ")) {
      String[] names=name.split(" ");
      if (names.length == 3) {
        firstName=names[0];
        middleName=names[1];
        lastName=names[2];
      }
 else {
        firstName=names[0];
        lastName=names[1];
      }
    }
    patient.setGivenName(firstName);
    patient.setMiddleName(middleName);
    patient.setFamilyName(lastName);
    patient.setGender(request.getParameter("gender"));
    Date birthdate=null;
    String date=request.getParameter("birthyear");
    String age=request.getParameter("age");
    if (date != null && !date.equals("")) {
      try {
        birthdate=DateFormat.getDateInstance(DateFormat.SHORT).parse("01/01/" + date);
      }
 catch (      ParseException e) {
        log.debug(e);
      }
    }
 else     if (age != null && !age.equals("")) {
      Calendar c=Calendar.getInstance();
      c.setTime(new Date());
      Integer d=c.get(Calendar.YEAR);
      d=d - Integer.parseInt(age);
      try {
        birthdate=DateFormat.getDateInstance(DateFormat.SHORT).parse("01/01/" + d);
      }
 catch (      ParseException e) {
        log.debug(e);
      }
    }
    if (birthdate != null)     patient.setBirthdate(birthdate);
  }
  return patient;
}
