{
  HttpSession httpSession=request.getSession();
  Context context=(Context)httpSession.getAttribute(WebConstants.OPENMRS_CONTEXT_HTTPSESSION_ATTR);
  Map<String,Object> map=new HashMap<String,Object>();
  List<PatientIdentifier> identifiers=new Vector<PatientIdentifier>();
  Patient patient=null;
  if (context != null && context.isAuthenticated()) {
    FormEntryService ps=context.getFormEntryService();
    String patientId=request.getParameter("pId");
    if (patientId != null && !patientId.equals("")) {
      patient=ps.getPatient(Integer.valueOf(patientId));
      identifiers.addAll(patient.getIdentifiers());
    }
  }
  map.put("datePattern",dateFormat.toLocalizedPattern().toLowerCase());
  identifiers.addAll(newIdentifiers);
  if (pref.length() > 0)   for (  PatientIdentifier pi : identifiers)   pi.setPreferred(pref.equals(pi.getIdentifier() + pi.getIdentifierType().getPatientIdentifierTypeId()));
  map.put("identifiers",identifiers);
  return map;
}
