{
  CustomValueDescriptor descriptor=val.getDescriptor();
  CustomDatatype<?> datatype=CustomDatatypeUtil.getDatatype(descriptor);
  CustomDatatypeHandler handler=CustomDatatypeUtil.getHandler(descriptor);
  if (handler != null && handler instanceof HtmlDisplayableDatatypeHandler) {
    Summary summary=((HtmlDisplayableDatatypeHandler)handler).toHtmlSummary(datatype,val.getValueReference());
    if (summary.isComplete()) {
      sb.append(summary);
    }
 else {
      sb.append(summary);
      sb.append("...");
      String link="viewCustomValue.form?handler=" + handler.getClass().getName() + "&datatype="+ datatype.getClass().getName()+ "&value="+ val.getValueReference();
      sb.append(" (<a target=\"_blank\" href=\"" + link + "\">"+ Context.getMessageSourceService().getMessage("general.view")+ "</a>)");
      if (handler instanceof DownloadableDatatypeHandler) {
        link="downloadCustomValue.form?handler=" + handler.getClass().getName() + "&datatype="+ datatype.getClass().getName()+ "&value="+ val.getValueReference();
        sb.append(" (<a href=\"" + link + "\">"+ Context.getMessageSourceService().getMessage("general.download")+ "</a>)");
      }
    }
  }
 else   if (datatype != null) {
    Summary summary=datatype.getTextSummary(val.getValueReference());
    if (summary.isComplete()) {
      sb.append(summary);
    }
 else {
      sb.append(summary);
      sb.append("...");
    }
  }
 else {
    sb.append(Context.getMessageSourceService().getMessage("CustomDatatype.error.missingDatatype",new Object[]{descriptor.getDatatypeClassname()},Context.getLocale()));
    sb.append(val.getValueReference());
  }
}
