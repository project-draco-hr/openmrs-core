{
  Patient patient=(Patient)obj;
  List<Form> forms=new Vector<Form>();
  Map<String,Object> map=new HashMap<String,Object>();
  List<Encounter> encounters=new Vector<Encounter>();
  if (Context.isAuthenticated() && patient.getPatientId() != null) {
    boolean onlyPublishedForms=true;
    if (Context.hasPrivilege(PrivilegeConstants.VIEW_UNPUBLISHED_FORMS))     onlyPublishedForms=false;
    forms.addAll(Context.getFormService().getForms(null,onlyPublishedForms,null,false,null,null,null));
    List<Encounter> encs=Context.getEncounterService().getEncountersByPatient(patient);
    if (encs != null && encs.size() > 0)     encounters.addAll(encs);
  }
  String patientVariation="";
  Concept reasonForExitConcept=Context.getConceptService().getConcept(Context.getAdministrationService().getGlobalProperty("concept.reasonExitedCare"));
  if (reasonForExitConcept != null && patient.getPatientId() != null) {
    List<Obs> patientExitObs=Context.getObsService().getObservationsByPersonAndConcept(patient,reasonForExitConcept);
    if (patientExitObs != null && patientExitObs.size() > 0) {
      log.debug("Exit obs is size " + patientExitObs.size());
      if (patientExitObs.size() == 1) {
        Obs exitObs=patientExitObs.iterator().next();
        Concept exitReason=exitObs.getValueCoded();
        Date exitDate=exitObs.getObsDatetime();
        if (exitReason != null && exitDate != null) {
          patientVariation="Exited";
        }
      }
 else {
        log.error("Too many reasons for exit - not putting data into model");
      }
    }
  }
  List<PatientIdentifierType> pits=Context.getPatientService().getAllPatientIdentifierTypes();
  boolean identifierLocationUsed=false;
  for (  PatientIdentifierType pit : pits) {
    if (pit.getLocationBehavior() == null || pit.getLocationBehavior() == LocationBehavior.REQUIRED) {
      identifierLocationUsed=true;
    }
  }
  map.put("identifierTypes",pits);
  map.put("identifierLocationUsed",identifierLocationUsed);
  map.put("identifiers",patient.getIdentifiers());
  map.put("patientVariation",patientVariation);
  map.put("forms",forms);
  map.put("emptyIdentifier",new PatientIdentifier());
  map.put("emptyName",new PersonName());
  map.put("emptyAddress",new PersonAddress());
  map.put("encounters",encounters);
  super.setupReferenceData(map,patient);
  return map;
}
