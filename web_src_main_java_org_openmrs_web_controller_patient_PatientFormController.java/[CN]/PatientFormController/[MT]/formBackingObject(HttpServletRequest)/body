{
  Patient patient=null;
  if (Context.isAuthenticated()) {
    PatientService ps=Context.getPatientService();
    String patientId=request.getParameter("patientId");
    Integer id;
    if (patientId != null) {
      try {
        id=Integer.valueOf(patientId);
        patient=ps.getPatientOrPromotePerson(id);
        if (patient == null) {
          HttpSession session=request.getSession();
          session.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"patientDashboard.noPatientWithId");
          session.setAttribute(WebConstants.OPENMRS_ERROR_ARGS,patientId);
          return new Patient();
        }
      }
 catch (      NumberFormatException numberError) {
        log.warn("Invalid patientId supplied: '" + patientId + "'",numberError);
      }
    }
  }
  if (patient == null) {
    patient=new Patient();
    String name=request.getParameter("addName");
    if (name != null) {
      String gender=request.getParameter("addGender");
      String date=request.getParameter("addBirthdate");
      String age=request.getParameter("addAge");
      getMiniPerson(patient,name,gender,date,age);
    }
  }
  if (patient.getIdentifiers().size() < 1) {
    patient.addIdentifier(new PatientIdentifier());
  }
 else {
    if (patient.getPatientIdentifier() != null && !patient.getPatientIdentifier().isPreferred()) {
      List<PatientIdentifier> pi=patient.getActiveIdentifiers();
      for (      PatientIdentifier patientIdentifier : pi) {
        if (!patientIdentifier.isVoided() && !patientIdentifier.getIdentifierType().isRetired()) {
          patientIdentifier.setPreferred(true);
          break;
        }
      }
    }
  }
  super.setupFormBackingObject(patient);
  return patient;
}
