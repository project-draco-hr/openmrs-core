{
  Criteria criteria=sessionFactory.getCurrentSession().createCriteria(Encounter.class);
  Date indexDate=Calendar.getInstance().getTime();
  Operator transformOperator=null;
  LogicTransform transform=expression.getTransform();
  Integer numResults=null;
  if (transform != null) {
    transformOperator=transform.getTransformOperator();
    numResults=transform.getNumResults();
  }
  if (numResults == null) {
    numResults=1;
  }
  if (transformOperator == Operator.LAST) {
    criteria.addOrder(Order.desc("encounterDatetime")).addOrder(Order.desc("dateCreated")).addOrder(Order.desc("encounterId"));
  }
 else   if (transformOperator == Operator.FIRST) {
    criteria.addOrder(Order.asc("encounterDatetime")).addOrder(Order.asc("encounterId"));
  }
 else   if (transformOperator == Operator.DISTINCT) {
    criteria.setResultTransformer(Criteria.DISTINCT_ROOT_ENTITY);
  }
  Criterion c=this.getCriterion(expression,indexDate);
  if (c != null) {
    criteria.add(c);
  }
  List<Encounter> results=new ArrayList<Encounter>();
  criteria.add(Restrictions.eq("voided",false));
  criteria.add(Restrictions.in("patient.personId",who.getMemberIds()));
  results.addAll(criteria.list());
  if (transformOperator == Operator.FIRST || transformOperator == Operator.LAST) {
    HashMap<Integer,ArrayList<Encounter>> nResultMap=new HashMap<Integer,ArrayList<Encounter>>();
    for (    Encounter currResult : results) {
      Integer currPersonId=currResult.getPatient().getPersonId();
      ArrayList<Encounter> prevResults=nResultMap.get(currPersonId);
      if (prevResults == null) {
        prevResults=new ArrayList<Encounter>();
        nResultMap.put(currPersonId,prevResults);
      }
      if (prevResults.size() < numResults) {
        prevResults.add(currResult);
      }
    }
    if (nResultMap.values().size() > 0) {
      results.clear();
      for (      ArrayList<Encounter> currPatientEncounter : nResultMap.values()) {
        results.addAll(currPatientEncounter);
      }
    }
  }
  return results;
}
