{
  initializeInMemoryDatabase();
  executeDataSet("org/openmrs/test/reporting/export/include/DataExportTest-patients.xml");
  executeDataSet("org/openmrs/test/reporting/export/include/DataExportTest-obs.xml");
  authenticate();
  DataExportReportObject export=new DataExportReportObject();
  export.setName("FIRST WEIGHT");
  SimpleColumn patientId=new SimpleColumn();
  patientId.setColumnName("PATIENT_ID");
  patientId.setReturnValue("$!{fn.patientId}");
  export.getColumns().add(patientId);
  ConceptColumn firstObs=new ConceptColumn();
  firstObs.setColumnName("WEIGHT");
  firstObs.setColumnType("concept");
  firstObs.setConceptId(5089);
  firstObs.setConceptName("Weight (KG)");
  firstObs.setModifier(DataExportReportObject.MODIFIER_FIRST);
  export.getColumns().add(firstObs);
  Cohort patients=new Cohort();
  patients.addMember(2);
  DataExportUtil.generateExport(export,patients,"\t",null);
  File exportFile=DataExportUtil.getGeneratedFile(export);
  String expectedOutput="PATIENT_ID\tWEIGHT\n2\t1.0\n";
  String output=OpenmrsUtil.getFileAsString(exportFile);
  exportFile.delete();
  assertEquals("The output is not right.",expectedOutput,output);
  export=new DataExportReportObject();
  export.setName("FIRST WEIGHT WITH LOCATION");
  export.getColumns().add(patientId);
  firstObs=new ConceptColumn();
  firstObs.setColumnName("WEIGHT");
  firstObs.setColumnType("concept");
  firstObs.setConceptId(5089);
  firstObs.setConceptName("Weight (KG)");
  firstObs.setExtras(new String[]{"location"});
  firstObs.setModifier(DataExportReportObject.MODIFIER_FIRST);
  export.getColumns().add(firstObs);
  DataExportUtil.generateExport(export,patients,"\t",null);
  exportFile=DataExportUtil.getGeneratedFile(export);
  expectedOutput="PATIENT_ID\tWEIGHT\tWEIGHT_location\n2\t1.0\tTest Location\n";
  output=OpenmrsUtil.getFileAsString(exportFile);
  exportFile.delete();
  assertEquals("The output is not right.",expectedOutput,output);
}
