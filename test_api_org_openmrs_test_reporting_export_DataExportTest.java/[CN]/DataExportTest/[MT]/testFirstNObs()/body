{
  initializeInMemoryDatabase();
  executeDataSet("org/openmrs/test/include/DataExportTest-patients.xml");
  executeDataSet("org/openmrs/test/include/DataExportTest-obs.xml");
  authenticate();
  DataExportReportObject export=new DataExportReportObject();
  export.setName("FIRST 2 WEIGHTS");
  SimpleColumn patientId=new SimpleColumn();
  patientId.setColumnName("PATIENT_ID");
  patientId.setReturnValue("$!{fn.patientId}");
  export.getColumns().add(patientId);
  ConceptColumn firstNObs=new ConceptColumn();
  firstNObs.setColumnName("WEIGHT");
  firstNObs.setColumnType("concept");
  firstNObs.setConceptId(5089);
  firstNObs.setConceptName("Weight (KG)");
  firstNObs.setExtras(new String[]{"location"});
  firstNObs.setModifier(DataExportReportObject.MODIFIER_FIRST_NUM);
  firstNObs.setModifierNum(2);
  export.getColumns().add(firstNObs);
  PatientSet patients=new PatientSet();
  patients.add(2);
  DataExportUtil.generateExport(export,patients,"\t");
  File exportFile=DataExportUtil.getGeneratedFile(export);
  String expectedOutput="PATIENT_ID	WEIGHT	WEIGHT_location 	WEIGHT_(1)	WEIGHT_location_(1)\n2	1.0	Test Location	2.0	Test Location\n";
  String output=OpenmrsUtil.getFileAsString(exportFile);
  exportFile.delete();
  assertEquals("The output is not right.",expectedOutput,output);
  export=new DataExportReportObject();
  export.setName("FIRST 1 WEIGHTS");
  export.addSimpleColumn("PATIENT_ID","$!{fn.patientId}");
  firstNObs=new ConceptColumn();
  firstNObs.setColumnName("WEIGHT");
  firstNObs.setColumnType("concept");
  firstNObs.setConceptId(5089);
  firstNObs.setConceptName("Weight (KG)");
  firstNObs.setExtras(new String[]{"location"});
  firstNObs.setModifier(DataExportReportObject.MODIFIER_FIRST_NUM);
  firstNObs.setModifierNum(1);
  export.getColumns().add(firstNObs);
  DataExportUtil.generateExport(export,patients,"\t");
  exportFile=DataExportUtil.getGeneratedFile(export);
  expectedOutput="PATIENT_ID	WEIGHT	WEIGHT_location\n2	1.0	Test Location\n";
  output=OpenmrsUtil.getFileAsString(exportFile);
  exportFile.delete();
  assertEquals("The output is not what was expected",expectedOutput,output);
  export=new DataExportReportObject();
  export.setName("FIRST -1 WEIGHTS");
  export.addSimpleColumn("PATIENT_ID","$!{fn.patientId}");
  firstNObs=new ConceptColumn();
  firstNObs.setColumnName("WEIGHT");
  firstNObs.setColumnType("concept");
  firstNObs.setConceptId(5089);
  firstNObs.setConceptName("Weight (KG)");
  firstNObs.setExtras(new String[]{"location"});
  firstNObs.setModifier(DataExportReportObject.MODIFIER_FIRST_NUM);
  firstNObs.setModifierNum(-1);
  export.getColumns().add(firstNObs);
  DataExportUtil.generateExport(export,patients,"\t");
  exportFile=DataExportUtil.getGeneratedFile(export);
  expectedOutput="PATIENT_ID	WEIGHT	WEIGHT_location\n2	10.0	Test Location	9.0	Test Location	8.0	Test Location	7.0	Test Location	6.0	Test Location	5.0	Test Location	4.0	Test Location	3.0	Test Location	2.0	Test Location	1.0	Test Location\n";
  output=OpenmrsUtil.getFileAsString(exportFile);
  exportFile.delete();
  assertEquals("The output is not what was expected",expectedOutput,output);
}
