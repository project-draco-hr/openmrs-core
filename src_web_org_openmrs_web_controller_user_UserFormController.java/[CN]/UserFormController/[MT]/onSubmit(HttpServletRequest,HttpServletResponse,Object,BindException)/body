{
  HttpSession httpSession=request.getSession();
  User user=(User)obj;
  String view=getFormView();
  if (Context.isAuthenticated()) {
    UserService us=Context.getUserService();
    String password=request.getParameter("userFormPassword");
    if (password == null || password.equals("XXXXXXXXXXXXXXX"))     password="";
    Map<String,String> properties=user.getUserProperties();
    if (properties == null)     properties=new HashMap<String,String>();
    Boolean newChangePassword=false;
    String chk=request.getParameter(OpenmrsConstants.USER_PROPERTY_CHANGE_PASSWORD);
    if (chk != null)     newChangePassword=true;
    if (!newChangePassword.booleanValue() && properties.containsKey(OpenmrsConstants.USER_PROPERTY_CHANGE_PASSWORD)) {
      properties.remove(OpenmrsConstants.USER_PROPERTY_CHANGE_PASSWORD);
    }
    if (newChangePassword.booleanValue()) {
      properties.put(OpenmrsConstants.USER_PROPERTY_CHANGE_PASSWORD,newChangePassword.toString());
    }
    String[] keys=request.getParameterValues("property");
    String[] values=request.getParameterValues("value");
    if (keys != null && values != null) {
      for (int x=0; x < keys.length; x++) {
        String key=keys[x];
        String val=values[x];
        properties.put(key,val);
      }
    }
    user.setUserProperties(properties);
    if (isNewUser(user))     us.saveUser(user,password);
 else {
      us.saveUser(user,null);
      if (!password.equals("") && Context.hasPrivilege(OpenmrsConstants.PRIV_EDIT_USER_PASSWORDS)) {
        if (log.isDebugEnabled())         log.debug("calling changePassword for user " + user + " by user "+ Context.getAuthenticatedUser());
        us.changePassword(user,password);
      }
    }
    httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"User.saved");
    view=getSuccessView();
  }
  return new ModelAndView(new RedirectView(view));
}
