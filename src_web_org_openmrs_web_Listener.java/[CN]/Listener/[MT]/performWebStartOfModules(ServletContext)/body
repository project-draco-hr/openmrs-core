{
  List<Module> startedModules=new ArrayList<Module>();
  startedModules.addAll(ModuleFactory.getStartedModules());
  boolean someModuleNeedsARefresh=false;
  for (  Module mod : startedModules) {
    try {
      boolean thisModuleCausesRefresh=WebModuleUtil.startModule(mod,servletContext,true);
      someModuleNeedsARefresh=someModuleNeedsARefresh || thisModuleCausesRefresh;
    }
 catch (    Throwable t) {
      mod.setStartupErrorMessage("Unable to start module",t);
    }
  }
  if (someModuleNeedsARefresh) {
    try {
      WebModuleUtil.refreshWAC(servletContext);
    }
 catch (    Throwable t) {
      log.fatal("Unable to refresh the spring application context. Unloading all modules,  Error was:",t);
      try {
        WebModuleUtil.shutdownModules(servletContext);
        for (        Module mod : ModuleFactory.getLoadedModules()) {
          ModuleFactory.stopModule(mod,true);
        }
        WebModuleUtil.refreshWAC(servletContext);
      }
 catch (      Throwable t2) {
        log.warn("caught another error: ",t2);
      }
    }
  }
}
