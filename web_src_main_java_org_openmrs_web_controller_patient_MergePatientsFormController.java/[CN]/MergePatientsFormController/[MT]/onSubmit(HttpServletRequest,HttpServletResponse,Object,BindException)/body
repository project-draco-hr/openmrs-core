{
  HttpSession httpSession=request.getSession();
  if (Context.isAuthenticated()) {
    StringBuilder view=new StringBuilder(getSuccessView());
    PatientService ps=Context.getPatientService();
    String pref=request.getParameter("preferred");
    String[] nonPreferred=request.getParameter("nonPreferred").split(",");
    String redirectURL=request.getParameter("redirectURL");
    String modalMode=request.getParameter("modalMode");
    Patient preferred=ps.getPatient(Integer.valueOf(pref));
    List<Patient> notPreferred=new ArrayList<Patient>();
    view.append("?patientId=").append(preferred.getPatientId());
    for (int i=0; i < nonPreferred.length; i++) {
      notPreferred.add(ps.getPatient(Integer.valueOf(nonPreferred[i])));
      view.append("&patientId=").append(nonPreferred[i]);
    }
    try {
      ps.mergePatients(preferred,notPreferred);
    }
 catch (    APIException e) {
      log.error("Unable to merge patients",e);
      httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"Patient.merge.fail");
      return showForm(request,response,errors);
    }
    httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Patient.merged");
    if ("true".equals(modalMode)) {
      return showForm(request,response,errors);
    }
    int index=redirectURL.indexOf(request.getContextPath(),2);
    if (index != -1) {
      redirectURL=redirectURL.substring(index);
      if (redirectURL.contains(getSuccessView())) {
        redirectURL="findDuplicatePatients.htm";
      }
    }
 else {
      redirectURL=view.toString();
    }
    return new ModelAndView(new RedirectView(redirectURL));
  }
  return new ModelAndView(new RedirectView(getFormView()));
}
