{
  Integer formId=null;
  Integer patientId=null;
  try {
    formId=Integer.parseInt(request.getParameter("formId"));
    patientId=Integer.parseInt(request.getParameter("patientId"));
  }
 catch (  NumberFormatException e) {
    log.warn("Invalid formId or patientId parameter: formId: \"" + request.getParameter("formId") + "\" patientId: "+ request.getParameter("patientId")+ "\"",e);
    return;
  }
  Patient patient=context.getFormEntryService().getPatient(patientId);
  Form form=context.getFormEntryService().getForm(formId);
  String url=FormUtil.getFormAbsoluteUrl(form);
  String title=form.getName();
  title+=" (" + form.getVersion();
  if (form.getBuild() != null)   title+="-" + form.getBuild();
  title+=")";
  title=title.replaceAll(" ","_");
  String xmldoc=new FormXmlTemplateBuilder(context,form,url).getXmlTemplate(patient);
  xmldoc=xmldoc.replaceAll("@SESSION@",httpSession.getId());
  response.setHeader("Content-Type","application/ms-infopath.xml");
  response.setHeader("Content-Disposition","attachment; filename=" + title + ".infopathxml");
  response.getOutputStream().print(xmldoc.toString());
}
