{
  MessageSourceService msa=Context.getMessageSourceService();
  Locale locale=Context.getLocale();
  StringBuilder ret=new StringBuilder();
  ret.append(msa.getMessage("reporting.patientsInProgram")).append(" ");
  if (getProgram() != null) {
    if (getProgram().getConcept() == null) {
      ret.append(" <").append(msa.getMessage("reporting.concept")).append("> ");
    }
 else {
      ret.append(getConceptName(program.getConcept())).append(" ");
    }
  }
  if (stateList != null && stateList.size() > 0) {
    Map<ProgramWorkflow,Set<ProgramWorkflowState>> map=new HashMap<ProgramWorkflow,Set<ProgramWorkflowState>>();
    for (    ProgramWorkflowState state : stateList) {
      ProgramWorkflow workflow=state.getProgramWorkflow();
      OpenmrsUtil.addToSetMap(map,workflow,state);
    }
    boolean first=true;
    for (    Map.Entry<ProgramWorkflow,Set<ProgramWorkflowState>> e : map.entrySet()) {
      ret.append(first ? msa.getMessage("reporting.with") + " " : msa.getMessage("reporting.or") + " ");
      first=false;
      try {
        ret.append(e.getKey().getConcept().getName().getName());
      }
 catch (      NullPointerException ex) {
        ret.append(msa.getMessage("reporting.concept")).append("?");
      }
      if (e.getValue().size() == 1) {
        ret.append(" ").append(msa.getMessage("reporting.of")).append(" ").append(e.getValue().iterator().next().getConcept().getName().getName());
      }
 else {
        ret.append(" ").append(msa.getMessage("reporting.in")).append(" [ ");
        for (Iterator<ProgramWorkflowState> i=e.getValue().iterator(); i.hasNext(); ) {
          ret.append(i.next().getConcept().getName().getName());
          if (i.hasNext()) {
            ret.append(" , ");
          }
        }
        ret.append(" ]");
      }
    }
  }
  if (withinLastMonths != null || withinLastDays != null) {
    if (withinLastMonths != null) {
      ret.append(" ").append(msa.getMessage("reporting.withinTheLastMonths",new Object[]{withinLastMonths},locale));
    }
    if (withinLastDays != null) {
      ret.append(" ").append(msa.getMessage("reporting.withinTheLastDays",new Object[]{withinLastDays},locale));
    }
  }
  if (sinceDate != null) {
    ret.append(msa.getMessage("reporting.onOrAfter",new Object[]{Context.getDateFormat().format(sinceDate)},locale));
  }
  if (untilDate != null) {
    ret.append(msa.getMessage("reporting.onOrBefore",new Object[]{Context.getDateFormat().format(untilDate)},locale));
  }
  return ret.toString();
}
