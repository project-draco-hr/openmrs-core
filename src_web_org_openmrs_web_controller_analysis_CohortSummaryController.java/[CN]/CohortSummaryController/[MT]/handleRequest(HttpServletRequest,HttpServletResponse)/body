{
  HttpSession httpSession=request.getSession();
  if (!Context.isAuthenticated()) {
    httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"auth.session.expired");
    return null;
  }
  PatientAnalysis analysis=Context.getPatientSetService().getMyPatientAnalysis();
  PatientSet ps=analysis.runFilters(Context.getPatientSetService().getAllPatients());
  ReportElement ageGenderGraph=new ReportElement();
  PatientDataProducer p=new PatientAttributeDataProducer("Patient","gender");
  ageGenderGraph.addProducer("gender",p);
  p=new PatientAttributeDataProducer("Patient","birthdate",new DataTransformer(){
    public Object transform(    Object o){
      return OpenmrsUtil.ageFromBirthdate((Date)o);
    }
  }
);
  ageGenderGraph.addProducer("age",p);
  NumericRangeColumnClassifier ageClassifier=new NumericRangeColumnClassifier("age","Unknown age");
  ageClassifier.addCutoff(15,"Child");
  ageClassifier.addLastLabel("Adult");
  CompoundClassifier classifier=new CompoundClassifier(" + ");
  classifier.addClassifiers(new SimpleColumnClassifier("gender","Unknown gender"),ageClassifier);
  TableGroupAndAggregate tga=new TableGroupAndAggregate(classifier,new CountAggregator(),"gender + age","Cohort.count");
  ageGenderGraph.addGroupAndAggregate(tga);
  DataTable ageGenderTable=ageGenderGraph.run(ps);
  httpSession.setAttribute("ageGenderDataTable",ageGenderTable);
  ReportElement enrollmentGraph=new ReportElement();
  Program program=Context.getProgramWorkflowService().getProgram("HIV PROGRAM");
  p=new PatientProgramDataProducer(program,PatientProgramDataProducer.WhichField.ENROLLMENT_DATE);
  enrollmentGraph.addProducer("hiv_enrollment_date",p);
  DateColumnClassifier dateClassifier=new DateColumnClassifier("hiv_enrollment_date",DateColumnClassifier.CombineMethod.MONTH,"unknown hiv enrollment date");
  tga=new TableGroupAndAggregate(dateClassifier,new CountAggregator(),"hiv_enrollment_date","count");
  enrollmentGraph.addGroupAndAggregate(tga);
  DataTable enrollmentTable=enrollmentGraph.run(ps);
  enrollmentTable.sortByColumn("hiv_enrollment_date");
  httpSession.setAttribute("hivEnrollmentDataTable",enrollmentTable);
  Map<String,Object> model=new HashMap<String,Object>();
  model.put("patientSet",ps);
  model.put("ageGenderTable",ageGenderTable);
  model.put("hivEnrollmentTable",enrollmentTable);
  return new ModelAndView("/analysis/cohortSummary","model",model);
}
