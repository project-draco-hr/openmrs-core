{
  if (DISCONTINUE != order.getAction()) {
    return;
  }
  Order previousOrder=order.getPreviousOrder();
  if (previousOrder != null) {
    stopOrder(previousOrder,aMomentBefore(order.getDateActivated()));
    return;
  }
  List<? extends Order> orders=getActiveOrders(order.getPatient(),order.getOrderType(),order.getCareSetting(),null);
  boolean isDrugOrderAndHasADrug=DrugOrder.class.isAssignableFrom(getActualType(order)) && ((DrugOrder)order).getDrug() != null;
  Order orderToBeDiscontinued=null;
  for (  Order activeOrder : orders) {
    if (!getActualType(order).equals(getActualType(activeOrder))) {
      continue;
    }
    if (isDrugOrderAndHasADrug) {
      if (orderToBeDiscontinued == null) {
        orderToBeDiscontinued=checkDrugOrdersForDiscontinuing((DrugOrder)order,(DrugOrder)activeOrder);
      }
 else {
        throw new AmbiguousOrderException("Order.discontinuing.ambiguous.orders");
      }
    }
 else     if (activeOrder.getConcept().equals(order.getConcept())) {
      if (orderToBeDiscontinued == null) {
        orderToBeDiscontinued=activeOrder;
      }
 else {
        throw new AmbiguousOrderException("Order.discontinuing.ambiguous.orders");
      }
    }
  }
  if (orderToBeDiscontinued != null) {
    order.setPreviousOrder(orderToBeDiscontinued);
    stopOrder(orderToBeDiscontinued,aMomentBefore(order.getDateActivated()));
  }
}
