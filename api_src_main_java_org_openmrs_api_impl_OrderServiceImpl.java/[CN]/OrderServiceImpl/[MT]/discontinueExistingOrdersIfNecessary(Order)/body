{
  if (DISCONTINUE != order.getAction()) {
    return;
  }
  Order previousOrder=order.getPreviousOrder();
  if (previousOrder != null) {
    stopOrder(previousOrder,order.getStartDate());
    return;
  }
  List<? extends Order> orders=getActiveOrders(order.getPatient(),order.getOrderType(),order.getCareSetting(),null);
  boolean isDrugOrderAndHasADrug=DrugOrder.class.isAssignableFrom(getActualType(order)) && ((DrugOrder)order).getDrug() != null;
  for (  Order activeOrder : orders) {
    if (!getActualType(order).equals(getActualType(activeOrder))) {
      continue;
    }
    boolean shouldMarkAsDiscontinued=false;
    if (isDrugOrderAndHasADrug) {
      DrugOrder drugOrder1=(DrugOrder)order;
      DrugOrder drugOrder2=(DrugOrder)activeOrder;
      if (OpenmrsUtil.nullSafeEquals(drugOrder1.getDrug(),drugOrder2.getDrug())) {
        shouldMarkAsDiscontinued=true;
      }
    }
 else     if (activeOrder.getConcept().equals(order.getConcept())) {
      shouldMarkAsDiscontinued=true;
    }
    if (shouldMarkAsDiscontinued) {
      order.setPreviousOrder(activeOrder);
      stopOrder(activeOrder,order.getStartDate());
      break;
    }
  }
}
