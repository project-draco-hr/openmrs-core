{
  if (user == null)   user=Context.getAuthenticatedUser();
  if (discontinueDate == null)   discontinueDate=new Date();
 else   if (discontinueDate.after(new Date()))   throw new APIException("Cannot discontinue an order in the future");
  if (oldOrder.getDiscontinued())   throw new APIException("Cannot discontinue an order that is already discontinued");
  if (oldOrder.getAutoExpireDate() != null && OpenmrsUtil.compare(discontinueDate,oldOrder.getAutoExpireDate()) > 0)   throw new APIException("Cannot discontinue an order after its autoexpire date");
  oldOrder.setDiscontinued(Boolean.TRUE);
  oldOrder.setDiscontinuedBy(user);
  oldOrder.setDiscontinuedDate(discontinueDate);
  saveOrderWithLesserValidation(oldOrder);
  Order newOrder=new Order();
  newOrder.setOrderNumber(getNewOrderNumber());
  newOrder.setConcept(oldOrder.getConcept());
  newOrder.setPatient(oldOrder.getPatient());
  newOrder.setPreviousOrderNumber(oldOrder.getOrderNumber());
  newOrder.setOrderAction(OrderAction.DISCONTINUE);
  newOrder.setStartDate(new Date());
  newOrder.setUuid(UUID.randomUUID().toString());
  Context.getOrderService().saveOrder(newOrder);
  return oldOrder;
}
