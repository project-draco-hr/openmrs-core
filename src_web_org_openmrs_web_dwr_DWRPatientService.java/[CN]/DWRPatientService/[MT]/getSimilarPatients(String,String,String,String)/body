{
  Vector<Object> patientList=new Vector<Object>();
  Context context=(Context)WebContextFactory.get().getSession().getAttribute(WebConstants.OPENMRS_CONTEXT_HTTPSESSION_ATTR);
  HttpServletRequest request=WebContextFactory.get().getHttpServletRequest();
  if (context == null) {
    patientList.add("Your session has expired.");
    patientList.add("Please <a href='" + request.getContextPath() + "/logout'>log in</a> again.");
  }
 else {
    Integer userId=context.getAuthenticatedUser().getUserId();
    log.info(userId + "|" + name+ "|"+ birthyear+ "|"+ age+ "|"+ gender);
    FormEntryService ps=context.getFormEntryService();
    List<Patient> patients=new Vector<Patient>();
    Integer d=null;
    birthyear=birthyear.trim();
    age=age.trim();
    if (birthyear.length() > 3)     d=Integer.valueOf(birthyear);
 else     if (age.length() > 0) {
      Calendar c=Calendar.getInstance();
      c.setTime(new Date());
      d=c.get(Calendar.YEAR);
      d=d - Integer.parseInt(age);
    }
    if (gender.length() < 1)     gender=null;
    patients.addAll(ps.getSimilarPatients(name,d,gender));
    patientList=new Vector<Object>(patients.size());
    for (    Patient p : patients) {
      patientList.add(new PatientListItem(p));
    }
  }
  return patientList;
}
