{
  ReportSchemaXml reportSchemaXml=(ReportSchemaXml)commandObject;
  ReportService reportService=(ReportService)Context.getService(ReportService.class);
  try {
    ReportSchema schema=reportService.getReportSchema(reportSchemaXml);
    if (reportSchemaXml.getReportSchemaId() != null && !schema.getReportSchemaId().equals(reportSchemaXml.getReportSchemaId())) {
      String xml=reportSchemaXml.getXml();
      reportSchemaXml=new ReportSchemaXml();
      reportSchemaXml.setXml(xml);
    }
    reportSchemaXml.populateFromReportSchema(schema);
    reportService.saveReportSchemaXml(reportSchemaXml);
  }
 catch (  Exception ex) {
    log.warn("Exception building ReportSchema from XML",ex);
    if (ex.getCause() != null) {
      Throwable temp=ex.getCause();
      while (temp.getCause() != null)       temp=temp.getCause();
      errors.rejectValue("xml",temp.getMessage());
    }
 else {
      StringBuilder sb=new StringBuilder();
      sb.append("Invalid XML content<br/>");
      sb.append(ex).append("<br/>");
      for (      StackTraceElement e : ex.getStackTrace())       sb.append(e.toString()).append("<br/>");
      errors.rejectValue("xml",sb.toString());
    }
    return showForm(request,response,errors);
  }
  HttpSession httpSession=request.getSession();
  httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Report.manageSchema.saved");
  return new ModelAndView(new RedirectView(getSuccessView()));
}
