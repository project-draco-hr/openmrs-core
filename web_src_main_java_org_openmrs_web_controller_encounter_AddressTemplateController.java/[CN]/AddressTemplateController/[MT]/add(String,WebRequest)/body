{
  if (!StringUtils.hasText(xml) || "".equals(xml.trim())) {
    request.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,Context.getMessageSourceService().getMessage("AddressTemplate.error.empty"),WebRequest.SCOPE_SESSION);
  }
 else {
    try {
      AddressTemplate test=Context.getSerializationService().getDefaultSerializer().deserialize(xml,AddressTemplate.class);
      List<String> requiredElements=test.getRequiredElements();
      if (requiredElements != null) {
        for (        String fieldName : requiredElements) {
          try {
            Object value=PropertyUtils.getProperty(new PersonAddress(),fieldName);
          }
 catch (          Exception e) {
            request.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,Context.getMessageSourceService().getMessage("AddressTemplate.error.fieldNotDeclaredInTemplate",new Object[]{fieldName},Context.getLocale()),WebRequest.SCOPE_SESSION);
            return "redirect:addressTemplate.form";
          }
        }
      }
      Context.getLocationService().saveAddressTemplate(xml);
      request.setAttribute(WebConstants.OPENMRS_MSG_ATTR,Context.getMessageSourceService().getMessage("AddressTemplate.saved"),WebRequest.SCOPE_SESSION);
    }
 catch (    Exception e) {
      String errmsg1=e.getCause().toString();
      if (errmsg1.contains("must be terminated by the matching")) {
        String errmsg2=e.getCause().getCause().toString();
        request.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,Context.getMessageSourceService().getMessage("AddressTemplate.error.elementInvalid",new Object[]{errmsg1.split("\"")[1],errmsg2.split(";")[1].split(":")[1]},Context.getLocale()),WebRequest.SCOPE_SESSION);
      }
 else       if (errmsg1.split("\n")[0].endsWith("null")) {
        for (        String part : errmsg1.split("\n")) {
          if (part.startsWith("path")) {
            request.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,Context.getMessageSourceService().getMessage("AddressTemplate.error.nameOrValueInvalid",new Object[]{part.split(":")[1]},Context.getLocale()),WebRequest.SCOPE_SESSION);
            break;
          }
        }
      }
 else       if (errmsg1.contains("UnknownFieldException") || errmsg1.contains("must be terminated by the matching")) {
        for (        String part : errmsg1.split("\n")) {
          if (part.startsWith("path")) {
            request.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,Context.getMessageSourceService().getMessage("AddressTemplate.error.wrongFieldName",new Object[]{part.split("/")[part.split("/").length - 1]},Context.getLocale()),WebRequest.SCOPE_SESSION);
            break;
          }
        }
      }
 else {
        request.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,Context.getMessageSourceService().getMessage("AddressTemplate.error"),WebRequest.SCOPE_SESSION);
      }
      request.setAttribute(WebConstants.OPENMRS_ADDR_TMPL,xml,WebRequest.SCOPE_SESSION);
    }
  }
  return "redirect:addressTemplate.form";
}
