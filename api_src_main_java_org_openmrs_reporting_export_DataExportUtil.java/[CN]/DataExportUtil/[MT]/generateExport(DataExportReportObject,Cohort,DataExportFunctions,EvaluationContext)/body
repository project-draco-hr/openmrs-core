{
  Log log=LogFactory.getLog(DataExportUtil.class);
  VelocityEngine velocityEngine=new VelocityEngine();
  velocityEngine.setProperty(RuntimeConstants.RUNTIME_LOG_LOGSYSTEM_CLASS,"org.apache.velocity.runtime.log.CommonsLogLogChute");
  velocityEngine.setProperty(CommonsLogLogChute.LOGCHUTE_COMMONS_LOG_NAME,"dataexport_velocity");
  try {
    velocityEngine.init();
  }
 catch (  Exception e) {
    log.error("Error initializing Velocity engine",e);
  }
  File file=getGeneratedFile(dataExport);
  PrintWriter report=new PrintWriter(file);
  VelocityContext velocityContext=new VelocityContext();
  if (patientSet == null) {
    patientSet=dataExport.generatePatientSet(context);
    functions.setAllPatients(dataExport.isAllPatients());
  }
  EventCartridge ec=new EventCartridge();
  ec.addEventHandler(new VelocityExceptionHandler());
  velocityContext.attachEventCartridge(ec);
  Locale locale=Context.getLocale();
  velocityContext.put("locale",locale);
  velocityContext.put("fn",functions);
  if (dataExportKeys != null && dataExportKeys.size() != 0) {
    for (    Map.Entry<String,Object> entry : dataExportKeys.entrySet()) {
      velocityContext.put(entry.getKey(),entry.getValue());
    }
  }
  velocityContext.put("patientSet",patientSet);
  String template=dataExport.generateTemplate();
  if (template.contains("fn.getPatientAttr('Patient', 'tribe')")) {
    throw new APIException("Unable to generate export: " + dataExport.getName() + " because it contains a reference to an outdated 'tribe' column.  You must install the 'Tribe Module' into OpenMRS to continue to reference tribes in OpenMRS.");
  }
  if (log.isDebugEnabled())   log.debug("Template: " + template.substring(0,template.length() < 3500 ? template.length() : 3500) + "...");
  try {
    velocityEngine.evaluate(velocityContext,report,DataExportUtil.class.getName(),template);
  }
 catch (  Exception e) {
    log.error("Error evaluating data export " + dataExport.getReportObjectId(),e);
    log.error("Template: " + template.substring(0,template.length() < 3500 ? template.length() : 3500) + "...");
    report.print("\n\nError: \n" + e.toString() + "\n Stacktrace: \n");
    e.printStackTrace(report);
  }
 finally {
    report.close();
    velocityContext.remove("fn");
    velocityContext.remove("patientSet");
    velocityContext=null;
    velocityEngine.init();
    velocityEngine=null;
    patientSet=null;
    functions.clear();
    functions=null;
    template=null;
    dataExport=null;
    log.debug("Clearing hibernate session");
    Context.clearSession();
    System.gc();
    System.gc();
  }
}
