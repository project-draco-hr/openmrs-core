{
  String success="";
  String error="";
  HttpSession httpSession=request.getSession();
  String view=getSuccessView();
  if (Context.isAuthenticated()) {
    MessageSourceAccessor msa=getMessageSourceAccessor();
    String action=request.getParameter("action");
    if (msa.getMessage("PatientSearch.save").equals(action)) {
      PatientSearchReportObject psroBinded=(PatientSearchReportObject)obj;
      String hiddenName=request.getParameter("hiddenName");
      String hiddenDesc=request.getParameter("hiddenDesc");
      int hasXMLChanged=0;
      hasXMLChanged=Integer.parseInt(request.getParameter("patientSearchXMLHasChanged"));
      String textAreaXML=request.getParameter("xmlStringTextArea");
      Integer argumentsLength=Integer.valueOf(request.getParameter("argumentsSize"));
      PatientSearch ps=null;
      String valueRoot="value";
      String hiddenValueRoot="hiddenValue";
      int testXMLerror=0;
      List<Integer> needsUpdate=new ArrayList<Integer>();
      for (int i=0; i < argumentsLength; i++) {
        String hv=request.getParameter(hiddenValueRoot + i);
        String v=request.getParameter(valueRoot + i);
        if (hv.compareTo(v) != 0)         needsUpdate.add(i);
      }
      String saved=msa.getMessage("PatientSearch.saved");
      String notsaved=msa.getMessage("PatientSearch.notsaved");
      String invalidXML=msa.getMessage("PatientSearch.invalidXML");
      String title=msa.getMessage("PatientSearch.title");
      boolean hasNewSearchArg=false;
      String newSearchArgName=(String)request.getParameter("newSearchArgName");
      String newSearchArgValue=(String)request.getParameter("newSearchArgValue");
      String newSearchArgClass=(String)request.getParameter("newSearchArgClass");
      if (StringUtils.hasText(newSearchArgName) || StringUtils.hasText(newSearchArgValue) || StringUtils.hasText(newSearchArgClass)) {
        hasNewSearchArg=true;
      }
      if (hiddenName.compareTo(psroBinded.getName()) != 0 || hiddenDesc.compareTo(psroBinded.getDescription()) != 0 || needsUpdate.size() > 0 || hasXMLChanged == 1 || hasNewSearchArg) {
        if (needsUpdate.size() > 0) {
          ps=psroBinded.getPatientSearch();
          List<SearchArgument> searchArguments=ps.getArguments();
          for (          Integer myI : needsUpdate) {
            SearchArgument sA=(SearchArgument)searchArguments.get(myI);
            SearchArgument newSA=new SearchArgument();
            newSA.setName(sA.getName());
            newSA.setPropertyClass(sA.getPropertyClass());
            newSA.setValue(request.getParameter(valueRoot + myI));
            searchArguments.set(myI,newSA);
          }
          ps.setArguments(searchArguments);
          psroBinded.setPatientSearch(ps);
        }
        if (hasXMLChanged == 1) {
          try {
            ReportObjectXMLDecoder roxd=new ReportObjectXMLDecoder(textAreaXML);
            PatientSearchReportObject psroFromXML=(PatientSearchReportObject)roxd.toAbstractReportObject();
            psroBinded.setDescription(psroFromXML.getDescription());
            psroBinded.setName(psroFromXML.getName());
            psroBinded.setPatientSearch(psroFromXML.getPatientSearch());
            psroBinded.setSubType(psroFromXML.getSubType());
            psroBinded.setType(psroFromXML.getType());
          }
 catch (          Exception ex) {
            log.warn("Invalid Patient Search XML",ex);
            error+=title + " " + notsaved+ ", "+ invalidXML;
            testXMLerror++;
          }
        }
        if (hasNewSearchArg) {
          if (StringUtils.hasText(newSearchArgName) && StringUtils.hasText(newSearchArgValue) && StringUtils.hasText(newSearchArgClass)) {
            try {
              psroBinded.getPatientSearch().addArgument(newSearchArgName,newSearchArgValue,Class.forName(newSearchArgClass));
            }
 catch (            Exception e) {
              error+=msa.getMessage("PatientSearch.invalidSearchArgument");
            }
          }
 else {
            error+=msa.getMessage("PatientSearch.invalidSearchArgument");
          }
          log.debug("Patient Search now has arguments: " + psroBinded.getPatientSearch().getArguments());
        }
        if (testXMLerror != 1 || hasNewSearchArg) {
          Context.getReportObjectService().updateReportObject(psroBinded);
          success=saved;
        }
      }
    }
  }
  if (!error.equals(""))   httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,error);
 else   if (!success.equals(""))   httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,success);
  return new ModelAndView(new RedirectView(view));
}
