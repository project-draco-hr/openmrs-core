{
  response.setContentType("text/html");
  HttpSession session=request.getSession();
  if (!Context.hasPrivilege(PrivilegeConstants.VIEW_PATIENTS)) {
    session.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"Privilege required: " + PrivilegeConstants.VIEW_PATIENTS);
    response.sendRedirect(request.getContextPath() + "/login.htm");
    return;
  }
  PrintWriter summary=response.getWriter();
  Cohort patientSet=getPatientSet(request,response);
  PatientService patientService=Context.getPatientService();
  LogicService logic=Context.getLogicService();
  summary.write("<clinicalSummaryList>\n");
  for (  Integer patientId : patientSet.getMemberIds()) {
    try {
      Result xml=logic.eval(patientService.getPatient(patientId),"CLINICAL SUMMARY");
      String s=xml.toString();
      summary.write(s);
      String[] lines=s.split("\n");
      for (int x=1; x < lines.length; x++) {
        summary.write(lines[x] + "\n");
      }
    }
 catch (    LogicException e) {
      throw new ServletException("Error while evaluating rule CLINICAL SUMMARY for patient: " + patientId,e);
    }
  }
  summary.write("</clinicalSummaryList>");
}
