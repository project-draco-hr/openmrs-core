{
  super.beforeCreateEncounter(encounter);
  if (encounter.getVisit() != null)   return;
  Visit visit=new Visit();
  visit.setStartDatetime(encounter.getEncounterDatetime());
  visit.setLocation(encounter.getLocation());
  visit.setPatient(encounter.getPatient());
  try {
    if (encounterVisitMapping == null) {
      encounterVisitMapping=CacheBuilder.newBuilder().build(new CacheLoader<EncounterType,VisitType>(){
        public VisitType load(        EncounterType key) throws APIException {
          return loadVisitType(key);
        }
      }
);
      Context.getAdministrationService().addGlobalPropertyListener(this);
    }
    VisitType visitType=encounterVisitMapping.get(encounter.getEncounterType());
    visit.setVisitType(visitType);
  }
 catch (  ExecutionException e) {
    throw new APIException("Error getting mapping encounter type - visit type from cache",e);
  }
  visit.setStopDatetime(OpenmrsUtil.getLastMomentOfDay(encounter.getEncounterDatetime()));
  encounter.setVisit(visit);
}
