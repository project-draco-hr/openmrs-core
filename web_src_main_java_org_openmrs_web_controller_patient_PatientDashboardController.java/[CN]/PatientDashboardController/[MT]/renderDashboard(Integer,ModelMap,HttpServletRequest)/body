{
  PatientService ps=Context.getPatientService();
  Patient patient=null;
  try {
    patient=ps.getPatient(patientId);
  }
 catch (  ObjectRetrievalFailureException noPatientEx) {
    log.warn("There is no patient with id: '" + patientId + "'",noPatientEx);
  }
  if (patient == null) {
    HttpSession session=request.getSession();
    session.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"patientDashboard.noPatientWithId");
    session.setAttribute(WebConstants.OPENMRS_ERROR_ARGS,patientId);
    return "findPatient";
  }
  log.debug("patient: '" + patient + "'");
  map.put("patient",patient);
  String causeOfDeathOther="";
  if (Context.isAuthenticated()) {
    String propCause=Context.getAdministrationService().getGlobalProperty("concept.causeOfDeath");
    Concept conceptCause=Context.getConceptService().getConcept(propCause);
    if (conceptCause != null) {
      List<Obs> obssDeath=Context.getObsService().getObservationsByPersonAndConcept(patient,conceptCause);
      if (obssDeath.size() == 1) {
        Obs obsDeath=obssDeath.iterator().next();
        causeOfDeathOther=obsDeath.getValueText();
        if (causeOfDeathOther == null) {
          log.debug("cod is null, so setting to empty string");
          causeOfDeathOther="";
        }
 else {
          log.debug("cod is valid: " + causeOfDeathOther);
        }
      }
 else {
        log.debug("obssDeath is wrong size: " + obssDeath.size());
      }
    }
 else {
      log.debug("No concept cause found");
    }
  }
  String patientVariation="";
  if (patient.isDead()) {
    patientVariation="Dead";
  }
  Concept reasonForExitConcept=Context.getConceptService().getConcept(Context.getAdministrationService().getGlobalProperty("concept.reasonExitedCare"));
  if (reasonForExitConcept != null) {
    List<Obs> patientExitObs=Context.getObsService().getObservationsByPersonAndConcept(patient,reasonForExitConcept);
    if (patientExitObs != null) {
      log.debug("Exit obs is size " + patientExitObs.size());
      if (patientExitObs.size() == 1) {
        Obs exitObs=patientExitObs.iterator().next();
        Concept exitReason=exitObs.getValueCoded();
        Date exitDate=exitObs.getObsDatetime();
        if (exitReason != null && exitDate != null) {
          patientVariation="Exited";
        }
      }
 else       if (patientExitObs.size() > 1) {
        log.error("Too many reasons for exit - not putting data into model");
      }
    }
  }
  map.put("patientVariation",patientVariation);
  map.put("emptyIdentifier",new PatientIdentifier());
  map.put("emptyName",new PersonName());
  map.put("emptyAddress",new PersonAddress());
  map.put("causeOfDeathOther",causeOfDeathOther);
  Set<Link> links=ExtensionUtil.getAllAddEncounterToVisitLinks();
  map.put("allAddEncounterToVisitLinks",links);
  return "patientDashboardForm";
}
