{
  String page=httpRequest.getParameter("page");
  Map<String,Object> referenceMap=new HashMap<String,Object>();
  if (DEFAULT_PAGE.equals(page)) {
    String username=httpRequest.getParameter("username");
    String password=httpRequest.getParameter("password");
    log.debug("Attempting to authenticate user: " + username);
    if (authenticateAsSuperUser(username,password)) {
      log.debug("Authentication successful.  Redirecting to 'reviewupdates' page.");
      authenticatedSuccessfully=true;
      referenceMap.put("isDatabaseUpdateInProgress",isDatabaseUpdateInProgress);
      renderTemplate(REVIEW_CHANGES,referenceMap,httpResponse);
    }
 else {
      try {
        log.debug("Sleeping for 3 seconds because of a bad username/password");
        Thread.sleep(3000);
      }
 catch (      InterruptedException e) {
        log.error("Unable to sleep",e);
        throw new ServletException("Got interrupted while trying to sleep thread",e);
      }
      errors.add("Unable to authenticate as a User with the " + OpenmrsConstants.SUPERUSER_ROLE + " role. Invalid username or password");
      renderTemplate(DEFAULT_PAGE,referenceMap,httpResponse);
    }
  }
 else   if (REVIEW_CHANGES.equals(page)) {
    if (!authenticatedSuccessfully) {
      renderTemplate(DEFAULT_PAGE,referenceMap,httpResponse);
      return;
    }
    if (!isDatabaseUpdateInProgress) {
      isDatabaseUpdateInProgress=true;
      updateJob=new UpdateFilterCompletion();
      updateJob.start();
      referenceMap.put("updateJobStarted",true);
    }
 else {
      referenceMap.put("isDatabaseUpdateInProgress",true);
      referenceMap.put("updateJobStarted",false);
    }
    renderTemplate(REVIEW_CHANGES,referenceMap,httpResponse);
  }
 else   if (PROGRESS_VM_AJAXREQUEST.equals(page)) {
    httpResponse.setContentType("text/json");
    httpResponse.setHeader("Cache-Control","no-cache");
    Map<String,Object> result=new HashMap<String,Object>();
    if (updateJob != null) {
      result.put("hasErrors",updateJob.hasErrors());
      if (updateJob.hasErrors()) {
        errors.addAll(updateJob.getErrors());
      }
      result.put("updatesRequired",updatesRequired());
      result.put("message",updateJob.getMessage());
      result.put("changesetIds",updateJob.getChangesetIds());
      result.put("executingChangesetId",updateJob.getExecutingChangesetId());
      Appender appender=Logger.getRootLogger().getAppender("MEMORY_APPENDER");
      if (appender instanceof MemoryAppender) {
        MemoryAppender memoryAppender=(MemoryAppender)appender;
        List<String> logLines=memoryAppender.getLogLines();
        if (logLines.size() > 5)         logLines=logLines.subList(logLines.size() - 5,logLines.size());
        result.put("logLines",logLines);
      }
 else {
        result.put("logLines",new ArrayList<String>());
      }
    }
    String jsonText=toJSONString(result);
    httpResponse.getWriter().write(jsonText);
  }
}
