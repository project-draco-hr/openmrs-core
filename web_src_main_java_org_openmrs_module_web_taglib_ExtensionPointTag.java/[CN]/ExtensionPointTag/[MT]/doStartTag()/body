{
  log.debug("Starting tag for extension point: " + pointId);
  extensions=null;
  parameterMap=OpenmrsUtil.parseParameterList(parameters);
  status=new HashMap<String,Object>();
  List<Extension> extensionList=null;
  List<Extension> validExtensions=new ArrayList<Extension>();
  if (type != null && type.length() > 0) {
    try {
      Extension.MEDIA_TYPE mediaType=Enum.valueOf(Extension.MEDIA_TYPE.class,type);
      log.debug("Getting extensions: " + pointId + " : "+ mediaType);
      extensionList=ModuleFactory.getExtensions(pointId,mediaType);
    }
 catch (    IllegalArgumentException e) {
      log.warn("extension point type: '" + type + "' is invalid. Must be enum of Extension.MEDIA_TYPE",e);
    }
  }
 else {
    log.debug("Getting extensions: " + pointId);
    extensionList=ModuleFactory.getExtensions(pointId);
  }
  if (extensionList != null) {
    log.debug("Found " + extensionList.size() + " extensions");
    if (requiredClass == null) {
      validExtensions=extensionList;
    }
 else {
      try {
        Class<?> clazz=Class.forName(requiredClass);
        for (        Extension ext : extensionList) {
          if (!clazz.isAssignableFrom(ext.getClass())) {
            log.warn("Extensions at this point (" + pointId + ") are "+ "required to be of "+ clazz+ " or a subclass. "+ ext.getClass()+ " is not.");
          }
 else {
            validExtensions.add(ext);
          }
        }
      }
 catch (      ClassNotFoundException ex) {
        throw new IllegalArgumentException(ex);
      }
    }
    extensions=validExtensions.iterator();
  }
  if (extensions == null || extensions.hasNext() == false) {
    extensions=null;
    return SKIP_BODY;
  }
 else {
    return EVAL_BODY_BUFFERED;
  }
}
