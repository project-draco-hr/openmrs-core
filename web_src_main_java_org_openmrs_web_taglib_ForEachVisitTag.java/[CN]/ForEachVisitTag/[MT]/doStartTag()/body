{
  if (visits == null || visits.isEmpty()) {
    log.debug("ForEachVisitTag skipping body due to 'visits' param = " + visits);
    return SKIP_BODY;
  }
  matchingVisits=new ArrayList<Visit>();
  for (Iterator<Visit> i=visits.iterator(); i.hasNext(); ) {
    Visit e=i.next();
    if (type == null || e.getVisitType().getVisitTypeId().intValue() == type.intValue()) {
      matchingVisits.add(e);
    }
  }
  log.debug("ForEachVisitTag found " + matchingVisits.size() + " visits matching type = "+ type);
  if (sortBy == null || sortBy.equals("")) {
    sortBy="visitDatetime";
  }
  Comparator comp=new BeanComparator(sortBy,(descending ? new ReverseComparator(new ComparableComparator()) : new ComparableComparator()));
  Collections.sort(matchingVisits,comp);
  if (matchingVisits.isEmpty()) {
    return SKIP_BODY;
  }
 else {
    pageContext.setAttribute(var,matchingVisits.get(count++));
    return EVAL_BODY_BUFFERED;
  }
}
