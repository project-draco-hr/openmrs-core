{
  HttpSession httpSession=request.getSession();
  String view=getFormView();
  if (Context.isAuthenticated()) {
    Drug drug=(Drug)obj;
    ConceptService conceptService=Context.getConceptService();
    if (request.getParameter("retireDrug") != null) {
      String retireReason=request.getParameter("retireReason");
      if (drug.getId() != null && (retireReason == null || retireReason.length() == 0)) {
        errors.reject("retireReason","ConceptDrug.retire.reason.empty");
        return showForm(request,response,errors);
      }
      conceptService.retireDrug(drug,retireReason);
      httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"ConceptDrug.retiredSuccessfully");
    }
 else     if (request.getParameter("unretireDrug") != null) {
      conceptService.unretireDrug(drug);
      httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"ConceptDrug.unretiredSuccessfully");
    }
 else     if (request.getParameter("purgeDrug") != null) {
      try {
        conceptService.purgeDrug(drug);
        httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"ConceptDrug.purgedSuccessfully");
      }
 catch (      DataIntegrityViolationException e) {
        httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"error.object.inuse.cannot.purge");
      }
    }
 else {
      conceptService.saveDrug(drug);
      httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"ConceptDrug.saved");
    }
    view=getSuccessView();
  }
  return new ModelAndView(new RedirectView(view));
}
