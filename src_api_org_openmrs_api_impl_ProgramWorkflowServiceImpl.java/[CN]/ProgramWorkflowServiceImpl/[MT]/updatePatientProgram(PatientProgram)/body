{
  if (!Context.getUserContext().hasPrivilege(OpenmrsConstants.PRIV_EDIT_PATIENT_PROGRAMS))   throw new APIAuthenticationException("Privilege required: " + OpenmrsConstants.PRIV_EDIT_PATIENT_PROGRAMS);
  Date now=new Date();
  p.setChangedBy(Context.getAuthenticatedUser());
  p.setDateChanged(now);
  for (  PatientState state : p.getStates()) {
    if (state.getDateCreated() == null)     state.setDateCreated(now);
    if (state.getCreator() == null)     state.setCreator(Context.getAuthenticatedUser());
  }
  getProgramWorkflowDAO().updatePatientProgram(p);
}
