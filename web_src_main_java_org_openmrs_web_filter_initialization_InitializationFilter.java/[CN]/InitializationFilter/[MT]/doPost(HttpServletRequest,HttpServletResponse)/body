{
  String page=httpRequest.getParameter("page");
  Map<String,Object> referenceMap=new HashMap<String,Object>();
  if (INSTALL_METHOD.equals(page)) {
    wizardModel.installMethod=httpRequest.getParameter("install_method");
    if (InitializationWizardModel.INSTALL_METHOD_SIMPLE.equals(wizardModel.installMethod)) {
      page=SIMPLE_SETUP;
    }
 else     if (InitializationWizardModel.INSTALL_METHOD_TESTING.equals(wizardModel.installMethod)) {
      page=TESTING_SETUP;
    }
 else {
      page=DATABASE_SETUP;
    }
    renderTemplate(page,referenceMap,httpResponse);
  }
 else   if (SIMPLE_SETUP.equals(page)) {
    if ("Back".equals(httpRequest.getParameter("back"))) {
      renderTemplate(INSTALL_METHOD,referenceMap,httpResponse);
      return;
    }
    wizardModel.databaseRootPassword=httpRequest.getParameter("database_root_password");
    checkForEmptyValue(wizardModel.databaseRootPassword,errors,"Database root password");
    wizardModel.hasCurrentOpenmrsDatabase=false;
    wizardModel.createTables=true;
    wizardModel.createDatabasePassword=wizardModel.databaseRootPassword;
    wizardModel.addDemoData=false;
    wizardModel.hasCurrentDatabaseUser=false;
    wizardModel.createDatabaseUser=true;
    wizardModel.createUserPassword=wizardModel.databaseRootPassword;
    wizardModel.moduleWebAdmin=true;
    wizardModel.autoUpdateDatabase=false;
    wizardModel.adminUserPassword=InitializationWizardModel.ADMIN_DEFAULT_PASSWORD;
    try {
      loadedDriverString=DatabaseUtil.loadDatabaseDriver(wizardModel.databaseConnection,wizardModel.databaseDriver);
    }
 catch (    ClassNotFoundException e) {
      errors.add("The given database driver class was not found. " + "Please ensure that the database driver jar file is on the class path " + "(like in the webapp's lib folder)");
      renderTemplate(page,referenceMap,httpResponse);
      return;
    }
    if (errors.isEmpty()) {
      page=WIZARD_COMPLETE;
    }
    renderTemplate(page,referenceMap,httpResponse);
  }
 else   if (DATABASE_SETUP.equals(page)) {
    if ("Back".equals(httpRequest.getParameter("back"))) {
      renderTemplate(INSTALL_METHOD,referenceMap,httpResponse);
      return;
    }
    wizardModel.databaseConnection=httpRequest.getParameter("database_connection");
    checkForEmptyValue(wizardModel.databaseConnection,errors,"Database connection string");
    wizardModel.databaseDriver=httpRequest.getParameter("database_driver");
    checkForEmptyValue(wizardModel.databaseConnection,errors,"Database connection string");
    loadedDriverString=loadDriver(wizardModel.databaseConnection,wizardModel.databaseDriver);
    if (!StringUtils.hasText(loadedDriverString)) {
      errors.add("The given database driver class was not found. " + "Please ensure that the database driver jar file is on the class path " + "(like in the webapp's lib folder)");
      renderTemplate(page,referenceMap,httpResponse);
      return;
    }
    if ("yes".equals(httpRequest.getParameter("current_openmrs_database"))) {
      wizardModel.databaseName=httpRequest.getParameter("openmrs_current_database_name");
      checkForEmptyValue(wizardModel.databaseName,errors,"Current database name");
      wizardModel.hasCurrentOpenmrsDatabase=true;
    }
 else {
      wizardModel.hasCurrentOpenmrsDatabase=false;
      wizardModel.createTables=true;
      wizardModel.databaseName=httpRequest.getParameter("openmrs_new_database_name");
      checkForEmptyValue(wizardModel.databaseName,errors,"New database name");
      wizardModel.createDatabaseUsername=httpRequest.getParameter("create_database_username");
      checkForEmptyValue(wizardModel.createDatabaseUsername,errors,"A user that has 'CREATE DATABASE' privileges");
      wizardModel.createDatabasePassword=httpRequest.getParameter("create_database_password");
      checkForEmptyValue(wizardModel.createDatabasePassword,errors,"Password for user with 'CREATE DATABASE' privileges");
    }
    if (errors.isEmpty()) {
      page=DATABASE_TABLES_AND_USER;
    }
    renderTemplate(page,referenceMap,httpResponse);
  }
 else   if (DATABASE_TABLES_AND_USER.equals(page)) {
    if ("Back".equals(httpRequest.getParameter("back"))) {
      renderTemplate(DATABASE_SETUP,referenceMap,httpResponse);
      return;
    }
    if (wizardModel.hasCurrentOpenmrsDatabase) {
      wizardModel.createTables="yes".equals(httpRequest.getParameter("create_tables"));
    }
    wizardModel.addDemoData="yes".equals(httpRequest.getParameter("add_demo_data"));
    if ("yes".equals(httpRequest.getParameter("current_database_user"))) {
      wizardModel.currentDatabaseUsername=httpRequest.getParameter("current_database_username");
      checkForEmptyValue(wizardModel.currentDatabaseUsername,errors,"Curent user account");
      wizardModel.currentDatabasePassword=httpRequest.getParameter("current_database_password");
      checkForEmptyValue(wizardModel.currentDatabasePassword,errors,"Current user account password");
      wizardModel.hasCurrentDatabaseUser=true;
      wizardModel.createDatabaseUser=false;
    }
 else {
      wizardModel.hasCurrentDatabaseUser=false;
      wizardModel.createDatabaseUser=true;
      wizardModel.createUserUsername=httpRequest.getParameter("create_user_username");
      checkForEmptyValue(wizardModel.createUserUsername,errors,"A user that has 'CREATE USER' privileges");
      wizardModel.createUserPassword=httpRequest.getParameter("create_user_password");
      checkForEmptyValue(wizardModel.createUserPassword,errors,"Password for user that has 'CREATE USER' privileges");
    }
    if (errors.isEmpty()) {
      page=OTHER_RUNTIME_PROPS;
    }
    renderTemplate(page,referenceMap,httpResponse);
  }
 else   if (OTHER_RUNTIME_PROPS.equals(page)) {
    if ("Back".equals(httpRequest.getParameter("back"))) {
      renderTemplate(DATABASE_TABLES_AND_USER,referenceMap,httpResponse);
      return;
    }
    wizardModel.moduleWebAdmin="yes".equals(httpRequest.getParameter("module_web_admin"));
    wizardModel.autoUpdateDatabase="yes".equals(httpRequest.getParameter("auto_update_database"));
    if (wizardModel.createTables) {
      page=ADMIN_USER_SETUP;
    }
 else {
      page=IMPLEMENTATION_ID_SETUP;
    }
    renderTemplate(page,referenceMap,httpResponse);
  }
 else   if (ADMIN_USER_SETUP.equals(page)) {
    if ("Back".equals(httpRequest.getParameter("back"))) {
      renderTemplate(OTHER_RUNTIME_PROPS,referenceMap,httpResponse);
      return;
    }
    wizardModel.adminUserPassword=httpRequest.getParameter("new_admin_password");
    String adminUserConfirm=httpRequest.getParameter("new_admin_password_confirm");
    if (!wizardModel.adminUserPassword.equals(adminUserConfirm)) {
      errors.add("Admin passwords don't match");
      renderTemplate(ADMIN_USER_SETUP,referenceMap,httpResponse);
      return;
    }
    if (wizardModel.adminUserPassword.equals("")) {
      errors.add("An admin password is required");
      renderTemplate(ADMIN_USER_SETUP,referenceMap,httpResponse);
      return;
    }
    try {
      OpenmrsUtil.validatePassword("admin",wizardModel.adminUserPassword,"admin");
    }
 catch (    PasswordException p) {
      errors.add("The password is not long enough, does not contain both uppercase characters and a number, or matches the username.");
      renderTemplate(ADMIN_USER_SETUP,referenceMap,httpResponse);
      return;
    }
    if (errors.isEmpty()) {
      page=IMPLEMENTATION_ID_SETUP;
    }
    renderTemplate(page,referenceMap,httpResponse);
  }
 else   if (IMPLEMENTATION_ID_SETUP.equals(page)) {
    if ("Back".equals(httpRequest.getParameter("back"))) {
      if (wizardModel.createTables)       renderTemplate(ADMIN_USER_SETUP,referenceMap,httpResponse);
 else       renderTemplate(OTHER_RUNTIME_PROPS,referenceMap,httpResponse);
      return;
    }
    wizardModel.implementationIdName=httpRequest.getParameter("implementation_name");
    wizardModel.implementationId=httpRequest.getParameter("implementation_id");
    wizardModel.implementationIdPassPhrase=httpRequest.getParameter("pass_phrase");
    wizardModel.implementationIdDescription=httpRequest.getParameter("description");
    if (wizardModel.implementationId.indexOf('^') != -1 || wizardModel.implementationId.indexOf('|') != -1) {
      errors.add("Implementation ID cannot contain '^' or '|'");
      renderTemplate(IMPLEMENTATION_ID_SETUP,referenceMap,httpResponse);
      return;
    }
    if (errors.isEmpty()) {
      page=WIZARD_COMPLETE;
    }
    renderTemplate(page,referenceMap,httpResponse);
  }
 else   if (WIZARD_COMPLETE.equals(page)) {
    if ("Back".equals(httpRequest.getParameter("back"))) {
      if (InitializationWizardModel.INSTALL_METHOD_SIMPLE.equals(wizardModel.installMethod)) {
        page=SIMPLE_SETUP;
      }
 else       if (InitializationWizardModel.INSTALL_METHOD_TESTING.equals(wizardModel.installMethod)) {
        page=TESTING_SETUP;
      }
 else {
        page=IMPLEMENTATION_ID_SETUP;
      }
      renderTemplate(page,referenceMap,httpResponse);
      return;
    }
    initJob=new InitializationCompletion();
    wizardModel.tasksToExecute=new ArrayList<WizardTask>();
    if (InitializationWizardModel.INSTALL_METHOD_TESTING.equals(wizardModel.installMethod)) {
      loadedDriverString=loadDriver(testDatabaseConnection,null);
      if (!StringUtils.hasText(loadedDriverString)) {
        page=TESTING_SETUP;
        errors.add("The given database driver class was not found. " + "Please ensure that the database driver jar file is on the class path " + "(like in the webapp's lib folder)");
        renderTemplate(page,referenceMap,httpResponse);
        return;
      }
      wizardModel.tasksToExecute.add(WizardTask.CREATE_TEST_INSTALLATION);
    }
 else {
      if (!wizardModel.hasCurrentOpenmrsDatabase)       wizardModel.tasksToExecute.add(WizardTask.CREATE_SCHEMA);
      if (wizardModel.createDatabaseUser)       wizardModel.tasksToExecute.add(WizardTask.CREATE_DB_USER);
      if (wizardModel.createTables) {
        wizardModel.tasksToExecute.add(WizardTask.CREATE_TABLES);
        wizardModel.tasksToExecute.add(WizardTask.ADD_CORE_DATA);
      }
      if (wizardModel.addDemoData)       wizardModel.tasksToExecute.add(WizardTask.ADD_DEMO_DATA);
    }
    wizardModel.tasksToExecute.add(WizardTask.UPDATE_TO_LATEST);
    referenceMap.put("tasksToExecute",wizardModel.tasksToExecute);
    initJob.start();
    renderTemplate(PROGRESS_VM,referenceMap,httpResponse);
  }
 else   if (TESTING_SETUP.equals(page)) {
    if ("Back".equals(httpRequest.getParameter("back"))) {
      renderTemplate(INSTALL_METHOD,referenceMap,httpResponse);
      return;
    }
    wizardModel.currentDatabaseHost=httpRequest.getParameter("currentDatabaseIpAddress");
    checkForEmptyValue(wizardModel.currentDatabaseHost,errors,"Current database Host Name/IP Address");
    wizardModel.currentDatabasePort=httpRequest.getParameter("currentDatabasePort");
    checkForEmptyValue(wizardModel.currentDatabasePort,errors,"Current database connection Port");
    wizardModel.currentDatabaseName=httpRequest.getParameter("currentDatabaseName");
    checkForEmptyValue(wizardModel.currentDatabaseName,errors,"Current database name");
    wizardModel.currentDatabaseUsername=httpRequest.getParameter("currentDatabaseUsername");
    checkForEmptyValue(wizardModel.currentDatabaseUsername,errors,"A database user with ALL privileges");
    wizardModel.currentDatabasePassword=httpRequest.getParameter("currentDatabasePassword");
    checkForEmptyValue(wizardModel.currentDatabasePassword,errors,"Password for database user with ALL privileges");
    wizardModel.testDatabaseHost=httpRequest.getParameter("test_database_host");
    checkForEmptyValue(wizardModel.testDatabaseHost,errors,"Test Connection Host Name/IP Address");
    wizardModel.testDatabasePort=httpRequest.getParameter("test_database_port");
    checkForEmptyValue(wizardModel.testDatabasePort,errors,"Test Connection Port");
    wizardModel.testDatabaseUsername=httpRequest.getParameter("test_database_username");
    checkForEmptyValue(wizardModel.testDatabaseUsername,errors,"Test Database Username");
    wizardModel.testDatabasePassword=httpRequest.getParameter("test_database_password");
    checkForEmptyValue(wizardModel.testDatabasePassword,errors,"Test Database Password");
    if (!errors.isEmpty()) {
      renderTemplate(page,referenceMap,httpResponse);
      return;
    }
    String addModules=httpRequest.getParameter("addModules");
    if (OpenmrsUtil.nullSafeEquals(addModules,"true"))     wizardModel.addModules=true;
 else {
      wizardModel.addModules=false;
      testModulesZipFile=null;
    }
    page=WIZARD_COMPLETE;
    renderTemplate(page,referenceMap,httpResponse);
    return;
  }
 else   if (InitializationWizardModel.INSTALL_METHOD_TESTING.equals(wizardModel.installMethod)) {
    httpResponse.setContentType("text/html");
    httpResponse.setHeader("Cache-Control","no-cache");
    PrintWriter pw=httpResponse.getWriter();
    String errorMsg=uploadFile(httpRequest);
    wizardModel.addModules=true;
    pw.write("<html><body>");
    pw.write("<script type=\"text/javascript\">window.parent.document.getElementById(\"spinner\").style.visibility=\"hidden\";</script>");
    if (errorMsg != null)     pw.write("<div align=\"center\"><font color=\"#FF0000\">" + errorMsg + "</font></div>");
 else     pw.write("<div align=\"center\"><font color=\"#0BA603\">File uploaded successfully!</font></div>");
    pw.write("</body></html>");
    return;
  }
}
