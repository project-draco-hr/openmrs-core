{
  HttpSession httpSession=request.getSession();
  String view=getFormView();
  try {
    Context.addProxyPrivilege(OpenmrsConstants.PRIV_VIEW_USERS);
    Context.addProxyPrivilege(OpenmrsConstants.PRIV_VIEW_PATIENTS);
    if (Context.isAuthenticated()) {
      Encounter encounter=(Encounter)obj;
      if (request.getParameter("patientId") != null)       encounter.setPatient(Context.getPatientService().getPatient(Integer.valueOf(request.getParameter("patientId"))));
      encounter.setProvider(Context.getPersonService().getPerson(Integer.valueOf(request.getParameter("providerId"))));
      if (encounter.isVoided() && encounter.getVoidedBy() == null)       Context.getEncounterService().voidEncounter(encounter,encounter.getVoidReason());
 else       if (!encounter.isVoided() && encounter.getVoidedBy() != null)       Context.getEncounterService().unvoidEncounter(encounter);
 else       Context.getEncounterService().saveEncounter(encounter);
      view=getSuccessView();
      view=view + "?encounterId=" + encounter.getEncounterId();
      httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Encounter.saved");
    }
  }
  finally {
    Context.removeProxyPrivilege(OpenmrsConstants.PRIV_VIEW_USERS);
    Context.removeProxyPrivilege(OpenmrsConstants.PRIV_VIEW_PATIENTS);
  }
  return new ModelAndView(new RedirectView(view));
}
