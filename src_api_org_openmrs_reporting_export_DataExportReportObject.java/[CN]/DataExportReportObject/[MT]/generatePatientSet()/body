{
  PatientSetService pss=Context.getPatientSetService();
  PatientSet patientSet=null;
  if (getPatientIds() == null || getPatientIds().size() == 0) {
    patientSet=Context.getPatientSetService().getAllPatients();
    setAllPatients(true);
  }
 else {
    patientSet=new PatientSet();
    for (    Integer p : patientIds)     patientSet.add(p);
  }
  if (location != null && !location.equals(""))   patientSet=patientSet.intersect(pss.getPatientsHavingLocation(getLocation()));
  if (cohortId != null) {
    Cohort cohort=Context.getCohortService().getCohort(cohortId);
    if (cohort != null)     patientSet=patientSet.intersect(cohort.toPatientSet());
  }
  if (cohortDefinitionId != null) {
    PatientFilter cohortDefinition=(PatientFilter)Context.getReportService().getReportObject(cohortDefinitionId);
    if (cohortDefinition != null)     patientSet=cohortDefinition.filter(patientSet);
  }
  if (patientSearchId != null) {
    PatientSearchReportObject search=(PatientSearchReportObject)Context.getReportService().getReportObject(patientSearchId);
    patientSet=OpenmrsUtil.toPatientFilter(search.getPatientSearch(),null).filter(patientSet);
  }
  return patientSet;
}
