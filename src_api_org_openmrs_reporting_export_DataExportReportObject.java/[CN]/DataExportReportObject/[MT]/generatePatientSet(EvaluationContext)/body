{
  PatientSetService pss=Context.getPatientSetService();
  Set<Integer> patientIdSet=new HashSet<Integer>();
  if (getPatientIds() == null || getPatientIds().size() == 0) {
    patientIdSet.addAll(Context.getPatientSetService().getAllPatients().getMemberIds());
    setAllPatients(true);
  }
 else {
    patientIdSet.addAll(patientIds);
  }
  if (location != null && !location.equals(""))   patientIdSet.retainAll(pss.getPatientsHavingLocation(getLocation()).getMemberIds());
  if (cohortId != null) {
    Cohort cohort=Context.getCohortService().getCohort(cohortId);
    if (cohort != null)     patientIdSet.retainAll(cohort.getMemberIds());
  }
  if (cohortDefinitionId != null) {
    PatientFilter cohortDefinition=(PatientFilter)Context.getReportObjectService().getReportObject(cohortDefinitionId);
    if (cohortDefinition != null) {
      Cohort c=new Cohort(patientIdSet);
      c=cohortDefinition.filter(c,context);
      patientIdSet=c.getMemberIds();
    }
  }
  if (patientSearchId != null) {
    PatientSearchReportObject search=(PatientSearchReportObject)Context.getReportObjectService().getReportObject(patientSearchId);
    PatientFilter cohortDefinition=OpenmrsUtil.toPatientFilter(search.getPatientSearch(),null);
    org.openmrs.Cohort c=new Cohort(patientIdSet);
    c=cohortDefinition.filter(c,context);
    patientIdSet=c.getMemberIds();
  }
  return new Cohort(patientIdSet);
}
