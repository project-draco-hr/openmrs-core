{
  log.debug("Updating concept set derivisions for #" + concept.getConceptId().toString());
  List<Concept> parents=getParents(concept);
  for (  Concept parent : parents) {
    sessionFactory.getCurrentSession().createQuery("delete from ConceptSetDerived csd where csd.concept in (select cs.concept from ConceptSet cs where cs.conceptSet = :c) and csd.conceptSet = :parent)").setParameter("c",concept).setParameter("parent",parent).executeUpdate();
  }
  Set<ConceptSetDerived> updates=new HashSet<ConceptSetDerived>();
  ConceptSetDerived csd;
  for (Integer a=0; a < parents.size() - 1; a++) {
    Concept set=parents.get(a);
    for (Integer b=a + 1; b < parents.size(); b++) {
      Concept conc=parents.get(b);
      csd=new ConceptSetDerived(set,conc,Double.valueOf(b.doubleValue()));
      updates.add(csd);
    }
  }
  updates.addAll(deriveChildren(parents,concept));
  for (  ConceptSetDerived c : updates) {
    sessionFactory.getCurrentSession().saveOrUpdate(c);
  }
}
