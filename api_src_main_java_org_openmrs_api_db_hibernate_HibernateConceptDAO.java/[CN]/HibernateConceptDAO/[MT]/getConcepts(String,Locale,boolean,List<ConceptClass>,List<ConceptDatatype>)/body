{
  StringBuilder query=new StringBuilder();
  final Locale locale;
  if (loc == null) {
    locale=Context.getLocale();
  }
 else {
    locale=loc;
  }
  if (!StringUtils.isBlank(name)) {
    if (searchOnPhrase) {
      String search=newNamesQuery(Sets.newHashSet(locale),name,true);
      query.append(search);
    }
 else {
      String search=newNamesQuery(Sets.newHashSet(locale),name,false);
      query.append(search);
    }
  }
  query.append(" +concept.retired:false");
  appendIdsQuery(query,"+concept.conceptClass.conceptClassId",classes);
  appendIdsQuery(query,"+concept.datatype.conceptDatatypeId",datatypes);
  final List<ConceptName> names=LuceneQuery.newQuery(query.toString(),sessionFactory.getCurrentSession(),ConceptName.class).skipSame("concept.conceptId","conceptNameId").list();
  final List<Concept> concepts=Lists.transform(names,transformNameToConcept);
  return concepts;
}
