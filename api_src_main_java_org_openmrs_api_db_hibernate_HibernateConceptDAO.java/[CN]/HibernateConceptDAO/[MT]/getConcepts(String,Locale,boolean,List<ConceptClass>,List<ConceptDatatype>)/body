{
  Criteria criteria=sessionFactory.getCurrentSession().createCriteria(Concept.class);
  criteria.add(Restrictions.eq("retired",false));
  if (!StringUtils.isBlank(name)) {
    if (loc == null) {
      loc=Context.getLocale();
    }
    String caseSensitiveNamesInConceptNameTable=Context.getAdministrationService().getGlobalProperty(OpenmrsConstants.GP_CASE_SENSITIVE_NAMES_IN_CONCEPT_NAME_TABLE,"true");
    criteria.createAlias("names","names");
    MatchMode matchmode=MatchMode.EXACT;
    if (searchOnPhrase) {
      matchmode=MatchMode.ANYWHERE;
    }
    if (Boolean.valueOf(caseSensitiveNamesInConceptNameTable)) {
      criteria.add(Restrictions.ilike("names.name",name,matchmode));
    }
 else {
      if (searchOnPhrase) {
        criteria.add(Restrictions.like("names.name",name,matchmode));
      }
 else {
        criteria.add(Restrictions.eq("names.name",name));
      }
    }
    criteria.add(Restrictions.eq("names.voided",false));
    String language=loc.getLanguage();
    if (language.length() > 2) {
      criteria.add(Restrictions.or(Restrictions.eq("names.locale",loc),Restrictions.eq("names.locale",new Locale(loc.getLanguage().substring(0,2)))));
    }
 else {
    }
  }
  if (classes.size() > 0) {
    criteria.add(Restrictions.in("conceptClass",classes));
  }
  if (datatypes.size() > 0) {
    criteria.add(Restrictions.in("datatype",datatypes));
  }
  return criteria.list();
}
