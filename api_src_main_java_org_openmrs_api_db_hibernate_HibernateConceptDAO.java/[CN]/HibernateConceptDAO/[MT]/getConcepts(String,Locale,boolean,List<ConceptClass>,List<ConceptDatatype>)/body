{
  final List<Concept> concepts=new LuceneQueryBuilder<Concept>(sessionFactory.getCurrentSession()){
    @Override protected org.apache.lucene.search.Query prepareQuery() throws ParseException {
      StringBuilder query=new StringBuilder();
      final Locale locale;
      if (loc == null) {
        locale=Context.getLocale();
      }
 else {
        locale=loc;
      }
      if (!StringUtils.isBlank(name)) {
        if (searchOnPhrase) {
          String searchPhrase=newRequirePartialWordsSearchPhrase(name);
          String search=newNamesQuery(locale,searchPhrase,true);
          query.append(search);
        }
 else {
          String search=newNamesQuery(locale,QueryParser.escape(name),false);
          query.append(search);
        }
      }
      query.append(" +retired:false");
      if (classes != null && !classes.isEmpty()) {
        String ids=transformToIds(classes);
        query.append(" +conceptClass.conceptClassId:(").append(ids).append(")");
      }
      if (datatypes != null && !datatypes.isEmpty()) {
        String ids=transformToIds(datatypes);
        query.append(" +datatype.conceptDatatypeId:(").append(ids).append(")");
      }
      return newQueryParser().parse(query.toString());
    }
  }
.list();
  return concepts;
}
