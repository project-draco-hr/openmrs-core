{
  StringBuilder query=new StringBuilder();
  final Locale locale;
  if (loc == null) {
    locale=Context.getLocale();
  }
 else {
    locale=loc;
  }
  if (!StringUtils.isBlank(name)) {
    if (searchOnPhrase) {
      String search=newNamesQuery(Sets.newHashSet(locale),name,true);
      query.append(search);
    }
 else {
      String search=newNamesQuery(Sets.newHashSet(locale),name,false);
      query.append(search);
    }
  }
  final List<ConceptName> names=LuceneQuery.newQuery(query.toString(),sessionFactory.getCurrentSession(),ConceptName.class).filter("concept.datatype.conceptDatatypeId",transformToIds(datatypes)).filter("concept.conceptClass.conceptClassId",transformToIds(classes)).filter("concept.retired","false").skipSame("concept.conceptId").list();
  final List<Concept> concepts=Lists.transform(names,transformNameToConcept);
  return concepts;
}
