{
  StringBuffer xml=new StringBuffer();
  xml.append(FormXmlTemplateFragment.header(form.getName(),form.getInfoPathSolutionVersion(),url));
  User user=encounter.getCreator();
  Date date=encounter.getEncounterDatetime();
  xml.append(FormXmlTemplateFragment.openForm(form.getFormId(),form.getName(),form.getVersion(),form.getSchemaNamespace(),user,date));
  TreeMap<Integer,TreeSet<FormField>> formStructure=FormUtil.getFormStructure(context,form);
  Hashtable<Integer,Vector<Obs>> obsMap=getObsForEncounter(encounter);
  renderStructure(xml,formStructure,encounter,obsMap,0,2);
  xml.append(FormXmlTemplateFragment.closeForm());
  return xml.toString();
}
