{
  if (!formStructure.containsKey(sectionId))   return;
  for (  FormField formField : formStructure.get(sectionId)) {
    String xmlTag=FormUtil.getNewTag(formField.getField().getName(),tagList);
    Integer subSectionId=formField.getFormFieldId();
    char[] indentation=new char[indent];
    for (int i=0; i < indent; i++)     indentation[i]=' ';
    xml.append(indentation);
    xml.append("<" + xmlTag);
    Field field=formField.getField();
    Integer fieldTypeId=field.getFieldType().getFieldTypeId();
    if (fieldTypeId.equals(FormEntryConstants.FIELD_TYPE_DATABASE)) {
      xml.append(" openmrs_table=\"");
      xml.append(formField.getField().getTableName());
      xml.append("\" openmrs_attribute=\"");
      xml.append(formField.getField().getAttributeName());
      if (formStructure.containsKey(formField.getFormFieldId())) {
        xml.append("\">\n");
        renderStructure(xml,formStructure,encounter,obsMap,subSectionId,indent + FormEntryConstants.INDENT_SIZE);
        xml.append(indentation);
      }
 else {
        if (field.getDefaultValue() != null) {
          xml.append("\">");
          renderValue(xml,encounter,obsMap,field);
        }
 else {
          xml.append("\">");
          renderValue(xml,encounter,obsMap,field);
        }
      }
      xml.append("</");
      xml.append(xmlTag);
      xml.append(">\n");
    }
 else     if (fieldTypeId.equals(FormEntryConstants.FIELD_TYPE_CONCEPT)) {
      Concept concept=field.getConcept();
      xml.append(" openmrs_concept=\"");
      xml.append(FormUtil.conceptToString(concept,context.getLocale()));
      xml.append("\" openmrs_datatype=\"");
      xml.append(concept.getDatatype().getHl7Abbreviation());
      xml.append("\"");
      if (formStructure.containsKey(formField.getFormFieldId())) {
        xml.append(">\n");
        renderStructure(xml,formStructure,encounter,obsMap,subSectionId,indent + FormEntryConstants.INDENT_SIZE);
        xml.append(indentation);
        xml.append("</");
        xml.append(xmlTag);
        xml.append(">\n");
      }
 else {
        if (concept.getDatatype().getHl7Abbreviation().equals(FormEntryConstants.HL7_CODED) || concept.getDatatype().getHl7Abbreviation().equals(FormEntryConstants.HL7_CODED_WITH_EXCEPTIONS)) {
          xml.append(" multiple=\"");
          xml.append(field.getSelectMultiple() ? "1" : "0");
          xml.append("\"");
        }
        xml.append(">\n");
        xml.append(indentation);
        xml.append(indentation);
        xml.append("<date xsi:nil=\"true\"></date>\n");
        xml.append(indentation);
        xml.append(indentation);
        xml.append("<time xsi:nil=\"true\"></time>\n");
        if ((concept.getDatatype().getHl7Abbreviation().equals(FormEntryConstants.HL7_CODED) || concept.getDatatype().getHl7Abbreviation().equals(FormEntryConstants.HL7_CODED_WITH_EXCEPTIONS)) && field.getSelectMultiple()) {
          for (          ConceptAnswer answer : concept.getAnswers()) {
            xml.append(indentation);
            xml.append(indentation);
            xml.append("<");
            String answerConceptName=answer.getAnswerConcept().getName(context.getLocale()).getName();
            Drug answerDrug=answer.getAnswerDrug();
            if (answerDrug == null) {
              String answerTag=FormUtil.getNewTag(answerConceptName,tagList);
              xml.append(answerTag);
              xml.append(" openmrs_concept=\"");
              xml.append(FormUtil.conceptToString(answer.getAnswerConcept(),context.getLocale()));
              xml.append("\">false</");
              xml.append(answerTag);
              xml.append(">\n");
            }
 else {
              String answerDrugName=answerDrug.getName();
              String answerTag=FormUtil.getNewTag(answerDrugName,tagList);
              xml.append(answerTag);
              xml.append(" openmrs_concept=\"");
              xml.append(FormUtil.conceptToString(answer.getAnswerConcept(),context.getLocale()));
              xml.append("^");
              xml.append(FormUtil.drugToString(answerDrug));
              xml.append("\">false</");
              xml.append(answerTag);
              xml.append(">\n");
            }
          }
        }
 else {
          xml.append(indentation);
          xml.append(indentation);
          xml.append("<value");
          if (concept.getDatatype().getHl7Abbreviation().equals(FormEntryConstants.HL7_BOOLEAN))           xml.append(" infopath_boolean_hack=\"1\"");
          xml.append(" xsi:nil=\"true\"></value>\n");
        }
        xml.append(indentation);
        xml.append("</");
        xml.append(xmlTag);
        xml.append(">\n");
      }
    }
 else {
      xml.append(">\n");
      renderStructure(xml,formStructure,encounter,obsMap,subSectionId,indent + FormEntryConstants.INDENT_SIZE);
      xml.append(indentation);
      xml.append("</");
      xml.append(xmlTag);
      xml.append(">\n");
    }
  }
}
