{
  Map<Integer,Collection<Integer>> activeDrugs=getPatientSetDAO().getActiveDrugIds(patientIds,onDate,onDate);
  Set<Integer> ret=new HashSet<Integer>();
  boolean takingAny=takingIds != null && takingIds.size() == 0;
  boolean takingNone=takingIds == null;
  if (takingAny) {
    ret.addAll(activeDrugs.keySet());
  }
 else   if (takingNone) {
    if (patientIds == null) {
      patientIds=getAllPatients().getMemberIds();
    }
    patientIds.removeAll(activeDrugs.keySet());
    ret.addAll(patientIds);
  }
 else {
    for (    Map.Entry<Integer,Collection<Integer>> e : activeDrugs.entrySet()) {
      for (      Integer drugId : takingIds) {
        if (e.getValue().contains(drugId)) {
          ret.add(e.getKey());
          break;
        }
      }
    }
  }
  return new Cohort(ret);
}
