{
  String chartTitle=request.getParameter("chartTitle") == null ? "" : request.getParameter("chartTitle");
  DataTable ageGenderData=(DataTable)request.getSession().getAttribute("ageGenderDataTable");
  ArrayList<TableRow> ageGenderRows=ageGenderData.getRows();
  DefaultKeyedValues keyValues=new DefaultKeyedValues();
  for (  TableRow row : ageGenderRows) {
    String category=(String)row.get("gender + age");
    Integer count=(Integer)row.get("Cohort.count");
    log.info("Adding value: " + count + " for "+ category);
    try {
      String[] catSplit=category.split(" \\+ ");
      String displayCategory="";
      if ("M".equals(catSplit[0])) {
        displayCategory="Male, ";
      }
 else       if ("F".equals(catSplit[0])) {
        displayCategory="Female, ";
      }
 else {
        displayCategory=catSplit[0];
      }
      keyValues.addValue(displayCategory + catSplit[1],count);
    }
 catch (    Exception e) {
      log.error(e);
    }
  }
  PieDataset pieSet=new DefaultPieDataset(keyValues);
  JFreeChart chart=ChartFactory.createPieChart(chartTitle,pieSet,false,true,false);
  PiePlot plot=(PiePlot)chart.getPlot();
  plot.setLabelGenerator(new StandardPieSectionLabelGenerator("{0} = {1} ({2})"));
  return chart;
}
