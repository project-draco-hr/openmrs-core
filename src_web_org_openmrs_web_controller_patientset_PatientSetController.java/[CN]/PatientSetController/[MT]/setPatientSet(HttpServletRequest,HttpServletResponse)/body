{
  String url=request.getParameter("url");
  String ps=request.getParameter("patientIds");
  if (ps == null) {
    ps="";
  }
  PatientSet patientSet=PatientSet.parseCommaSeparatedPatientIds(ps);
  Context.getPatientSetService().setMyPatientSet(patientSet);
  log.debug("Set user's PatientSet (" + patientSet.size() + " patients)");
  if (patientSet.size() > 0) {
    if ("true".equals(request.getParameter("appendPatientId")))     url+=(url.indexOf('?') >= 0 ? "&" : "?") + "patientId=" + patientSet.getPatientIds().iterator().next();
    if ("true".equals(request.getParameter("showPatientSet")))     url+=(url.indexOf('?') >= 0 ? "&" : "?") + "showPatientSet=true";
  }
  return new ModelAndView(new RedirectView(url));
}
