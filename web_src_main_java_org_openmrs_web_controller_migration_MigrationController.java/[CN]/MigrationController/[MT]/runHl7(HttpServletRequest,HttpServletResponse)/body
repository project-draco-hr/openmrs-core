{
  List<String> messages=new ArrayList<String>();
  String filename=request.getParameter("filename");
  if (filename != null && filename.length() > 0) {
    try {
      BufferedReader r=new BufferedReader(new FileReader(filename));
      StringBuilder thisMessage=new StringBuilder();
      while (true) {
        String line=r.readLine();
        if (line == null || line.startsWith("MSH")) {
          if (thisMessage.length() != 0) {
            messages.add(thisMessage.toString());
            log.debug("read message : " + thisMessage);
            if (messages.size() % 100 == 0) {
              log.debug("read " + messages.size() + " messages so far");
            }
            thisMessage=new StringBuilder();
          }
        }
        if (line == null) {
          break;
        }
        thisMessage.append(line).append('\r');
      }
    }
 catch (    Exception ex) {
      log.error("Failed to read hl7 input file " + filename,ex);
      throw new RuntimeException(ex);
    }
  }
 else {
    String hl7=request.getParameter("hl7");
    hl7=hl7.replaceAll("\\n","");
    for (int index=hl7.indexOf("MSH"); index >= 0; index=hl7.indexOf("MSH",index + 1)) {
      int endIndex=hl7.indexOf("MSH",index + 1);
      String oneMessage=endIndex <= 0 ? hl7.substring(index) : hl7.substring(index,endIndex);
      messages.add(oneMessage);
    }
  }
  for (  String oneMessage : messages) {
    log.debug("oneMessage: " + oneMessage);
    HL7InQueue hl7InQueue=new HL7InQueue();
    hl7InQueue.setHL7Data(oneMessage);
    HL7Service hs=Context.getHL7Service();
    if (hs.getAllHL7Sources().isEmpty()) {
      HL7Source hl7Source=new HL7Source();
      hl7Source.setName("MigrationTestTool");
      hl7Source.setDescription("Testing migrating data, from MigrationController.");
      hs.saveHL7Source(hl7Source);
    }
    hl7InQueue.setHL7Source(Context.getHL7Service().getHL7Source(1));
    log.debug("hl7InQueue.hl7Data: " + hl7InQueue.getHL7Data());
    Context.getHL7Service().saveHL7InQueue(hl7InQueue);
  }
  return new ModelAndView(new RedirectView("migration.form"));
}
