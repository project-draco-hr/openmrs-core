{
  Map<String,Object> model=new HashMap<String,Object>();
  if (Context.isAuthenticated()) {
    CohortSearchHistory history=getMySearchHistory(request);
    if (history == null) {
      history=new CohortSearchHistory();
      setMySearchHistory(request,history);
    }
    List<Shortcut> shortcuts=new ArrayList<Shortcut>();
    String shortcutProperty=Context.getAdministrationService().getGlobalProperty("cohort.cohortBuilder.shortcuts");
    if (shortcutProperty != null && shortcutProperty.length() > 0) {
      String[] shortcutSpecs=shortcutProperty.split(";");
      for (int i=0; i < shortcutSpecs.length; ++i) {
        try {
          shortcuts.add(new Shortcut(shortcutSpecs[i]));
        }
 catch (        Exception ex) {
          log.error("Exception trying to create filter from shortcut",ex);
        }
      }
    }
    ConceptService cs=Context.getConceptService();
    List<Concept> orderStopReasons=new ArrayList<Concept>();
{
      Concept c=cs.getConceptByName("REASON ORDER STOPPED");
      if (c != null)       orderStopReasons.addAll(cs.getConceptsInSet(c));
      if (c != null && c.getAnswers() != null)       for (      ConceptAnswer ca : c.getAnswers())       orderStopReasons.add(ca.getAnswerConcept());
    }
    List<Concept> genericDrugs=Context.getConceptService().getConceptsWithDrugsInFormulary();
    Collections.sort(genericDrugs,new Comparator<Concept>(){
      public int compare(      Concept left,      Concept right){
        return left.getName().getName().compareTo(right.getName().getName());
      }
    }
);
    List<Concept> drugSets=new ArrayList<Concept>();
{
      String temp=Context.getAdministrationService().getGlobalProperty("cohortBuilder.drugSets");
      if (StringUtils.hasText(temp)) {
        String[] drugSetNames=temp.split(",");
        for (        String setName : drugSetNames) {
          Concept c=Context.getConceptService().getConceptByIdOrName(setName);
          if (c != null)           drugSets.add(c);
        }
      }
    }
    model.put("searchHistory",history);
    model.put("links",linkHelper());
    model.put("programs",Context.getProgramWorkflowService().getPrograms());
    model.put("encounterTypes",Context.getEncounterService().getEncounterTypes());
    model.put("locations",Context.getEncounterService().getLocations());
    model.put("forms",Context.getFormService().getForms());
    model.put("drugs",Context.getConceptService().getDrugs());
    model.put("drugConcepts",genericDrugs);
    model.put("drugSets",drugSets);
    model.put("orderStopReasons",orderStopReasons);
    model.put("personAttributeTypes",Context.getPersonService().getPersonAttributeTypes());
    model.put("shortcuts",shortcuts);
  }
  return new ModelAndView(formView,"model",model);
}
