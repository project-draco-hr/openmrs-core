{
  Context.requirePrivilege(PrivilegeConstants.CONFIGURE_VISITS);
  new ConfigureVisitsFormValidator().validate(form,errors);
  if (errors.hasErrors()) {
    return;
  }
  GlobalProperty gpEnableVisits=new GlobalProperty(OpenmrsConstants.GLOBAL_PROPERTY_ENABLE_VISITS,Boolean.toString(form.isEnableVisits()));
  administrationService.saveGlobalProperty(gpEnableVisits);
  if (form.isEnableVisits()) {
    String type=form.getVisitEncounterHandler();
    GlobalProperty gpVisitEncounterHandler=new GlobalProperty(OpenmrsConstants.GP_VISIT_ASSIGNMENT_HANDLER,type);
    administrationService.saveGlobalProperty(gpVisitEncounterHandler);
  }
 else {
    form.setVisitEncounterHandler(administrationService.getGlobalProperty(OpenmrsConstants.GP_VISIT_ASSIGNMENT_HANDLER));
  }
  String visitTypeNames="";
  boolean isFirst=true;
  for (  VisitType vt : form.getVisitTypesToClose()) {
    if (isFirst) {
      visitTypeNames+=vt.getName();
      isFirst=false;
      continue;
    }
    visitTypeNames+="," + vt.getName();
  }
  GlobalProperty gpVisitTypesToClose=administrationService.getGlobalPropertyObject(OpenmrsConstants.GP_VISIT_TYPES_TO_AUTO_CLOSE);
  if (gpVisitTypesToClose == null)   gpVisitTypesToClose=new GlobalProperty(OpenmrsConstants.GP_VISIT_TYPES_TO_AUTO_CLOSE);
  gpVisitTypesToClose.setPropertyValue(visitTypeNames);
  administrationService.saveGlobalProperty(gpVisitTypesToClose);
  TaskDefinition closeVisitsTask=Context.getSchedulerService().getTaskByName(OpenmrsConstants.AUTO_CLOSE_VISITS_TASK_NAME);
  if (closeVisitsTask != null) {
    try {
      if (form.getCloseVisitsTaskStarted() && !closeVisitsTask.getStarted())       Context.getSchedulerService().scheduleTask(closeVisitsTask);
 else       if (!form.getCloseVisitsTaskStarted() && closeVisitsTask.getStarted())       Context.getSchedulerService().shutdownTask(closeVisitsTask);
    }
 catch (    SchedulerException e) {
      errors.rejectValue("closeVisitsTaskStarted",(form.getCloseVisitsTaskStarted()) ? "Visit.configure.closeVisitsTask.failedToStart" : "Visit.configure.closeVisitsTask.failedToStop");
    }
  }
  request.getSession().setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Encounter.visits.configuration.savedSuccessfully");
}
