{
  Session session=HibernateUtil.currentSession();
  Map<Integer,Encounter> ret=new HashMap<Integer,Encounter>();
  Set<Integer> ids=patients.getPatientIds();
  Criteria criteria=session.createCriteria(Encounter.class);
  criteria.add(Restrictions.in("patient.patientId",ids));
  criteria.add(Restrictions.eq("voided",false));
  if (encType != null)   criteria.add(Restrictions.eq("encounterType",encType));
  criteria.addOrder(org.hibernate.criterion.Order.desc("patient.patientId"));
  criteria.addOrder(org.hibernate.criterion.Order.desc("encounterDatetime"));
  List<Encounter> encounters=criteria.list();
  for (  Encounter enc : encounters) {
    Integer ptId=enc.getPatient().getPatientId();
    if (!ret.containsKey(ptId))     ret.put(ptId,enc);
  }
  return ret;
}
