{
  HttpSession httpSession=request.getSession();
  Context context=(Context)httpSession.getAttribute(WebConstants.OPENMRS_CONTEXT_HTTPSESSION_ATTR);
  String view=getFormView();
  if (context != null && context.isAuthenticated()) {
    Form form=(Form)obj;
    MessageSourceAccessor msa=getMessageSourceAccessor();
    String action=request.getParameter("action");
    if (action == null) {
      httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"Form.not.saved");
    }
 else {
      if (action.equals(msa.getMessage("Form.save"))) {
        try {
          if (request instanceof MultipartHttpServletRequest) {
            MultipartHttpServletRequest multipartRequest=(MultipartHttpServletRequest)request;
            MultipartFile xsltFile=multipartRequest.getFile("xslt_file");
            if (xsltFile != null && !xsltFile.isEmpty()) {
              String xslt=IOUtils.toString(xsltFile.getInputStream());
              form.setXslt(xslt);
            }
          }
          context.getFormService().updateForm(form);
          httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Form.saved");
        }
 catch (        Exception e) {
          log.error(e);
          errors.reject(e.getMessage());
          httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"Form.not.saved");
          return showForm(request,response,errors);
        }
      }
 else       if (action.equals(msa.getMessage("Form.delete"))) {
        try {
          context.getFormService().deleteForm(form);
          httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Form.deleted");
        }
 catch (        Exception e) {
          log.error(e);
          errors.reject(e.getMessage());
          httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"Form.cannot.delete");
          return showForm(request,response,errors);
        }
      }
 else {
        try {
          context.getFormService().duplicateForm(form);
          httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Form.duplicated");
        }
 catch (        Exception e) {
          log.error(e);
          errors.reject(e.getMessage());
          httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"Form.cannot.duplicate");
          return showForm(request,response,errors);
        }
      }
      view=getSuccessView();
    }
  }
  return new ModelAndView(new RedirectView(view));
}
