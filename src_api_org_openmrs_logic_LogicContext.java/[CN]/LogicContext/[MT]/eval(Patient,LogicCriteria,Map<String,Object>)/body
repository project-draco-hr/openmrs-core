{
  Result result=getCache().get(patient,criteria,parameters);
  PatientService patientService=Context.getPatientService();
  if (result == null) {
    Integer targetPatientId=patient.getPatientId();
    log.debug("Context database read (pid = " + targetPatientId + ")");
    Rule rule=Context.getLogicService().getRule(criteria.getRootToken());
    Map<Integer,Result> resultMap=new Hashtable<Integer,Result>();
    for (    Integer pid : patients.getMemberIds()) {
      Patient currPatient=patientService.getPatient(pid);
      Result r=Result.emptyResult();
      if (rule instanceof ReferenceRule) {
        r=((ReferenceRule)rule).eval(this,currPatient,criteria);
      }
 else {
        r=rule.eval(this,currPatient,parameters);
        r=applyCriteria(r,criteria);
      }
      resultMap.put(pid,r);
      if (pid.equals(targetPatientId))       result=resultMap.get(pid);
    }
    getCache().put(criteria,parameters,rule.getTTL(),resultMap);
  }
  return result;
}
