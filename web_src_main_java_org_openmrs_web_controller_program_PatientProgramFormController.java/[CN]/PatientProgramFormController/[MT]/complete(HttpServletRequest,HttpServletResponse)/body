{
  String returnPage=request.getParameter("returnPage");
  if (returnPage == null) {
    throw new IllegalArgumentException("must specify a returnPage parameter in a call to enroll()");
  }
  String patientProgramIdStr=request.getParameter("patientProgramId");
  String dateCompletedStr=request.getParameter("dateCompleted");
  CustomDateEditor cde=new CustomDateEditor(Context.getDateFormat(),true,10);
  cde.setAsText(dateCompletedStr);
  Date dateCompleted=(Date)cde.getValue();
  PatientProgram p=Context.getProgramWorkflowService().getPatientProgram(Integer.valueOf(patientProgramIdStr));
  p.setDateCompleted(dateCompleted);
  try {
    ValidateUtil.invokeValidatorInManualFlushMode(p);
    Context.getProgramWorkflowService().savePatientProgram(p);
  }
 catch (  APIException e) {
    request.getSession().setAttribute(WebConstants.OPENMRS_ERROR_ATTR,e.getMessage());
  }
  return new ModelAndView(new RedirectView(returnPage));
}
