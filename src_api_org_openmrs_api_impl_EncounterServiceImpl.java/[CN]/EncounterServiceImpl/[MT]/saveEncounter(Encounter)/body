{
  Date now=new Date();
  User me=Context.getAuthenticatedUser();
  boolean isNewEncounter=false;
  Date newDate=encounter.getEncounterDatetime();
  Date originalDate=null;
  if (encounter.getEncounterId() == null) {
    isNewEncounter=true;
    Context.requirePrivilege(OpenmrsConstants.PRIV_ADD_ENCOUNTERS);
  }
 else {
    Context.requirePrivilege(OpenmrsConstants.PRIV_EDIT_ENCOUNTERS);
  }
  if (encounter.getDateCreated() == null)   encounter.setDateCreated(now);
  if (encounter.getCreator() == null)   encounter.setCreator(me);
  for (  Obs o : encounter.getAllObs(true)) {
    if (o.getDateCreated() == null)     o.setDateCreated(now);
    if (o.getCreator() == null)     o.setCreator(me);
  }
  if (encounter.getOrders() != null) {
    for (    Order o : encounter.getOrders()) {
      if (o.getDateCreated() == null)       o.setDateCreated(now);
      if (o.getCreator() == null)       o.setCreator(me);
    }
  }
  if (isNewEncounter == false)   originalDate=dao.getSavedEncounterDatetime(encounter);
  dao.saveEncounter(encounter);
  if (isNewEncounter == false) {
    ObsService obsService=Context.getObsService();
    Patient p=encounter.getPatient();
    for (    Obs obs : encounter.getAllObs(true)) {
      boolean obsWasChanged=false;
      if (OpenmrsUtil.compare(originalDate,newDate) != 0) {
        if (OpenmrsUtil.compare(obs.getObsDatetime(),originalDate) == 0) {
          obs.setObsDatetime(newDate);
          obsWasChanged=true;
        }
        if (!obs.getPerson().getPersonId().equals(p.getPatientId())) {
          obs.setPerson(p);
          obsWasChanged=true;
        }
        if (obsWasChanged)         obsService.saveObs(obs,"Encounter datetime or person was changed");
      }
    }
    OrderService orderService=Context.getOrderService();
    for (    Order o : encounter.getOrders()) {
      if (!p.equals(o.getPatient())) {
        o.setPatient(p);
        orderService.saveOrder(o);
      }
    }
  }
  return encounter;
}
