{
  if (log.isTraceEnabled())   log.trace("Getting service: " + cls);
synchronized (contextRefreshedLock) {
    try {
      while (!contextRefreshedCheck) {
        log.warn("Waiting to get service: " + cls + " while the context is being refreshed");
        contextRefreshedLock.wait();
        log.warn("Finished waiting to get service " + cls + " while the context was being refreshed");
      }
    }
 catch (    InterruptedException e) {
      log.warn("Refresh lock was interrupted",e);
    }
  }
  Object service=services.get(cls);
  if (service == null)   throw new APIException("Service not found: " + cls);
  return (T)service;
}
