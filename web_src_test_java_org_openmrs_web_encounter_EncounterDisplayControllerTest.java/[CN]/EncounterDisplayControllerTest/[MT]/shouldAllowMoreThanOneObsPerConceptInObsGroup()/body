{
  executeDataSet("org/openmrs/web/encounter/include/EncounterDisplayControllerTest-multiconceptsinobsGroup.xml");
  MockHttpServletRequest request=new MockHttpServletRequest();
  request.setParameter("encounterId","5");
  EncounterDisplayController controller=new EncounterDisplayController();
  ModelAndView modelAndView=controller.handleRequest(request,new MockHttpServletResponse());
  Map<String,Object> model=(Map<String,Object>)modelAndView.getModel().get("model");
  Map<Integer,List<FieldHolder>> pages=(Map<Integer,List<FieldHolder>>)model.get("pages");
  Assert.assertNotNull(pages);
  List<FieldHolder> fieldHoldersOnPage=pages.get(999);
  if (fieldHoldersOnPage == null)   fieldHoldersOnPage=pages.get(0);
  for (  FieldHolder fieldHolder : fieldHoldersOnPage) {
    Assert.assertTrue(fieldHolder.isObsGrouping());
    Map<Obs,List<List<Obs>>> matrix=fieldHolder.getObsGroupMatrix();
    Assert.assertEquals(1,matrix.keySet().size());
    List<List<Obs>> listOfCells=null;
    for (    Obs obs : matrix.keySet()) {
      if (obs.getId() == 16) {
        listOfCells=matrix.get(obs);
      }
    }
    Assert.assertNotNull(listOfCells);
    List<Obs> firstAndOnlyCell=listOfCells.get(0);
    Assert.assertEquals(2,firstAndOnlyCell.size());
    Assert.assertTrue(containsId(firstAndOnlyCell,17));
    Assert.assertTrue(containsId(firstAndOnlyCell,18));
  }
}
