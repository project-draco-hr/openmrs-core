{
  if (mod != null) {
    String moduleId=mod.getModuleId();
    getStartedModulesMap().remove(moduleId);
    if (isShuttingDown == false) {
      Context.addProxyPrivilege("");
      AdministrationService as=Context.getAdministrationService();
      GlobalProperty gp=new GlobalProperty(moduleId + ".started","false",getGlobalPropertyStartedDescription(moduleId));
      as.setGlobalProperty(gp);
      Context.removeProxyPrivilege("");
    }
    if (getModuleClassLoaderMap().containsKey(mod)) {
      log.debug("Mod was in classloader map.  Removing advice and extensions.");
      try {
        for (        AdvicePoint advice : mod.getAdvicePoints()) {
          Class cls=null;
          try {
            cls=Class.forName(advice.getPoint());
            Object aopObject=advice.getClassInstance();
            if (Advisor.class.isInstance(aopObject)) {
              log.debug("adding advisor: " + aopObject.getClass());
              Context.removeAdvisor(cls,(Advisor)aopObject);
            }
 else {
              log.debug("Adding advice: " + aopObject.getClass());
              Context.removeAdvice(cls,(Advice)aopObject);
            }
          }
 catch (          ClassNotFoundException e) {
            log.warn("Could not remove advice point: " + advice.getPoint(),e);
          }
        }
      }
 catch (      Exception e) {
        log.warn("Error while getting advicePoints from module: " + moduleId,e);
      }
      try {
        for (        Extension ext : mod.getExtensions()) {
          String extId=ext.getExtensionId();
          try {
            List<Extension> tmpExtensions=getExtensions(extId);
            if (tmpExtensions == null)             tmpExtensions=new Vector<Extension>();
            tmpExtensions.remove(ext);
            getExtensionMap().put(extId,tmpExtensions);
          }
 catch (          Exception exterror) {
            log.warn("Error while getting extension: " + ext,exterror);
          }
        }
      }
 catch (      Exception e) {
        log.warn("Error while getting extensions from module: " + moduleId,e);
      }
    }
    try {
      mod.getActivator().shutdown();
    }
 catch (    ModuleException me) {
      log.debug("Exception encountered while calling module's activator.shutdown()",me);
    }
catch (    Exception e) {
      log.warn("Unable to call module's Activator.shutdown() method",e);
    }
    ModuleClassLoader cl=removeClassLoader(mod);
    if (cl != null) {
      cl.dispose();
      cl=null;
      File folder=OpenmrsClassLoader.getLibCacheFolder();
      File tmpModuleDir=new File(folder,moduleId);
      try {
        System.gc();
        OpenmrsUtil.deleteDirectory(tmpModuleDir);
      }
 catch (      IOException e) {
        log.warn("Unable to delete libcachefolder for " + moduleId);
      }
    }
    System.gc();
  }
}
