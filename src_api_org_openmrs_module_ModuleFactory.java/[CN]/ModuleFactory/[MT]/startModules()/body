{
  if (getLoadedModules().size() > 0) {
    List<Module> leftoverModules=new Vector<Module>();
    try {
      Context.addProxyPrivilege("");
      AdministrationService as=Context.getAdministrationService();
      for (      Module mod : getLoadedModules()) {
        String key=mod.getModuleId() + ".started";
        String prop=as.getGlobalProperty(key,null);
        if (prop == null || prop.equals("true")) {
          if (requiredModulesStarted(mod))           try {
            if (log.isDebugEnabled())             log.debug("starting module: " + mod.getModuleId());
            startModule(mod);
          }
 catch (          Exception e) {
            log.error("Error while starting module: " + mod.getName(),e);
            mod.setStartupErrorMessage("Error while starting module",e);
          }
 else {
            leftoverModules.add(mod);
            if (log.isDebugEnabled())             log.debug("cannot start because required modules are not started: " + mod.getModuleId());
          }
        }
      }
    }
  finally {
      Context.removeProxyPrivilege("");
    }
    boolean atLeastOneModuleLoaded=true;
    while (leftoverModules.size() > 0 && atLeastOneModuleLoaded) {
      if (log.isDebugEnabled())       log.debug("Trying to start leftover modules: " + leftoverModules);
      atLeastOneModuleLoaded=false;
      List<Module> modulesStartedInThisLoop=new Vector<Module>();
      for (      Module leftoverModule : leftoverModules) {
        if (requiredModulesStarted(leftoverModule)) {
          if (log.isDebugEnabled())           log.debug("starting leftover module: " + leftoverModule.getModuleId());
          try {
            startModule(leftoverModule);
            atLeastOneModuleLoaded=true;
            modulesStartedInThisLoop.add(leftoverModule);
          }
 catch (          Exception e) {
            log.error("Error while starting leftover module: " + leftoverModule.getName(),e);
          }
        }
 else {
          if (log.isDebugEnabled())           log.debug("cannot start leftover module because required modules are not started: " + leftoverModule.getModuleId());
        }
      }
      leftoverModules.removeAll(modulesStartedInThisLoop);
    }
    if (leftoverModules.size() > 0)     for (    Module leftoverModule : leftoverModules) {
      String message="Unable to start module '" + leftoverModule.getName() + "'.  All required modules are not available: "+ OpenmrsUtil.join(leftoverModule.getRequiredModules(),", ");
      log.error(message);
      leftoverModule.setStartupErrorMessage(message);
    }
  }
}
