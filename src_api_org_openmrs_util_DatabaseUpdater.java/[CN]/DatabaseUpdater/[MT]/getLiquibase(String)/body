{
  Connection connection=null;
  try {
    connection=getConnection();
    Database database=DatabaseFactory.getInstance().findCorrectDatabaseImplementation(connection);
    database.setDatabaseChangeLogTableName("liquibasechangelog");
    database.setDatabaseChangeLogLockTableName("liquibasechangeloglock");
    if (connection.getMetaData().getDatabaseProductName().contains("hsqldb")) {
      database.setDatabaseChangeLogTableName(database.getDatabaseChangeLogTableName().toUpperCase());
      database.setDatabaseChangeLogLockTableName(database.getDatabaseChangeLogLockTableName().toUpperCase());
    }
    FileOpener clFO=new ClassLoaderFileOpener();
    FileOpener fsFO=new FileSystemFileOpener();
    if (changeLogFile == null)     changeLogFile=CHANGE_LOG_FILE;
    return new Liquibase(changeLogFile,new CompositeFileOpener(clFO,fsFO),database);
  }
 catch (  Exception e) {
    if (connection != null)     connection.close();
    throw e;
  }
}
