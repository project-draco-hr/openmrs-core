{
  Visit visit=null;
  List<String> errors=new ArrayList<String>();
  MessageSourceService mss=Context.getMessageSourceService();
  try {
    if (visitId != null) {
      visit=Context.getVisitService().getVisit(visitId);
      if (endDateTime != null && endDateTime.length() > 0) {
        visit.setStopDatetime(Context.getDateTimeFormat().parse(endDateTime));
      }
 else {
        throw new APIException(Context.getMessageSourceService().getMessage("VisitStopDate.cannotBeNull"));
      }
    }
 else {
      throw new APIException(Context.getMessageSourceService().getMessage("VisitId.cannotBeNull"));
    }
    Errors bindErrors=new BindException(visit,"visit");
    new VisitValidator().validate(visit,bindErrors);
    if (bindErrors.hasErrors()) {
      for (      ObjectError objectError : bindErrors.getAllErrors())       errors.add(mss.getMessage(objectError.getCode()));
    }
 else {
      Context.getVisitService().saveVisit(visit);
      errors.add(0,"/patientDashboard.form?patientId=" + visit.getPatient().getPatientId());
    }
  }
 catch (  Exception e) {
    errors.add(mss.getMessage("Visit.save.error"));
    System.out.println("Exception : " + e.getMessage());
  }
  return errors;
}
