{
  authenticate();
  ObsService obsService=Context.getObsService();
  String hl7string="MSH|^~\\&|FORMENTRY|AMRS.ELD|HL7LISTENER|AMRS.ELD|20080226103553||ORU^R01|OD9PWqcD9g0NKn81rvSD|P|2.5|1||||||||66^AMRS.ELD.FORMID\rPID|||2^^^^||John^Doe^||\rPV1||O|1^Unknown Location||||1^Super User (1-8)|||||||||||||||||||||||||||||||||||||20080205|||||||V\rORC|RE||||||||20080226103428|1^Super User\rOBR|1|||1238^MEDICAL RECORD OBSERVATIONS^99DCT\rOBX|1|DT|1592^MISSED RETURNED VISIT DATE^99DCT||20080201|||||||||20080205\rOBR|2|||1726^FOLLOW-UP ACTION^99DCT\rOBX|1|CWE|1558^PATIENT CONTACT METHOD^99DCT|1|1555^PHONE^99DCT|||||||||20080205\rOBX|2|NM|1553^NUMBER OF ATTEMPTS^99DCT|1|1|||||||||20080205\rOBX|3|NM|1554^SUCCESSFUL^99DCT|1|1|||||||||20080205";
  Message hl7message=parser.parse(hl7string);
  router.processMessage(hl7message);
  Patient patient=new Patient(2);
  Set<Obs> obsForPatient2=obsService.getObservations(patient,false);
  assertNotNull(obsForPatient2);
  assertTrue("There should be some obs created for #3",obsForPatient2.size() > 0);
  Concept returnVisitDateConcept=new Concept(1592);
  Calendar cal=new GregorianCalendar();
  cal.set(2008,Calendar.FEBRUARY,1,0,0,0);
  Date returnVisitDate=cal.getTime();
  Set<Obs> returnVisitDateObsForPatient2=obsService.getObservations(patient,returnVisitDateConcept,false);
  assertEquals("There should be a return visit date",1,returnVisitDateObsForPatient2.size());
  Obs firstObs=(Obs)returnVisitDateObsForPatient2.toArray()[0];
  assertEquals("The date should be the 1st",returnVisitDate.toString(),firstObs.getValueDatetime().toString());
  Concept contactMethod=new Concept(1558);
  Concept phoneContact=Context.getConceptService().getConcept(1555);
  Set<Obs> contactMethodObsForPatient2=obsService.getObservations(patient,contactMethod,false);
  assertEquals("There should be a contact method",1,contactMethodObsForPatient2.size());
  Obs firstContactMethodObs=(Obs)contactMethodObsForPatient2.toArray()[0];
  assertEquals("The contact method should be phone",phoneContact,firstContactMethodObs.getValueCoded());
  Integer obsGroupId=firstContactMethodObs.getObsGroupId();
  assertNotNull("Their should be a group id",obsGroupId);
  List<Integer> groupedConceptIds=new Vector<Integer>();
  groupedConceptIds.add(1558);
  groupedConceptIds.add(1553);
  groupedConceptIds.add(1554);
  for (  Obs obs : obsForPatient2) {
    if (groupedConceptIds.contains(obs.getConcept().getConceptId())) {
      assertEquals("All of the group ids should match",obsGroupId,obs.getObsGroupId());
    }
  }
}
