{
  if (log.isTraceEnabled())   log.trace("Getting service: " + cls);
synchronized (refreshingContext) {
    if (refreshingContext.booleanValue())     try {
      log.warn("Waiting to get service: " + cls + " while the context is being refreshed");
      refreshingContext.wait();
      log.warn("Finished waiting to get service " + cls + " while the context was being refreshed");
    }
 catch (    InterruptedException e) {
      log.warn("Refresh lock was interrupted",e);
    }
  }
  ProxyFactory factory=proxyFactories.get(cls);
  if (factory == null)   throw new APIException("Service not found: " + cls);
  return (T)factory.getProxy(OpenmrsClassLoader.getInstance());
}
