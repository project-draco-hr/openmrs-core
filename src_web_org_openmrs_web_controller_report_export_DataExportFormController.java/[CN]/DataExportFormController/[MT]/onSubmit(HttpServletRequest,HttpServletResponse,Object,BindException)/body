{
  HttpSession httpSession=request.getSession();
  String view=getFormView();
  if (Context.isAuthenticated()) {
    DataExportReportObject report=(DataExportReportObject)obj;
    String[] patientIds=request.getParameterValues("patientId");
    report.setPatientIds(new Vector<Integer>());
    if (patientIds != null)     for (    String patientId : patientIds)     if (patientId != null && !patientId.equals(""))     report.addPatientId(Integer.valueOf(patientId));
    Integer location=ServletRequestUtils.getIntParameter(request,"location",0);
    if (location > 0)     report.setLocation(Context.getEncounterService().getLocation(location));
    String[] columnIds=request.getParameterValues("columnId");
    report.setColumns(new Vector<ExportColumn>());
    if (columnIds != null) {
      for (      String columnId : columnIds) {
        String columnName=request.getParameter("simpleName_" + columnId);
        if (columnName != null)         report.addSimpleColumn(columnName,request.getParameter("simpleValue_" + columnId));
 else {
          columnName=request.getParameter("conceptColumnName_" + columnId);
          if (columnName != null) {
            String conceptId=request.getParameter("conceptId_" + columnId);
            try {
              Integer.valueOf(conceptId);
            }
 catch (            NumberFormatException e) {
              Concept c=Context.getConceptService().getConceptByName(conceptId);
              if (c == null)               throw new APIException("Concept name : + '" + conceptId + "' could not be found in the dictionary");
              conceptId=c.getConceptId().toString();
            }
            String[] extras=request.getParameterValues("conceptExtra_" + columnId);
            String modifier=request.getParameter("conceptModifier_" + columnId);
            String modifierNumStr=request.getParameter("conceptModifierNum_" + columnId);
            Integer modifierNum=null;
            if (modifierNumStr.length() > 0)             modifierNum=Integer.valueOf(modifierNumStr);
            report.addConceptColumn(columnName,modifier,modifierNum,conceptId,extras);
          }
 else {
            columnName=request.getParameter("calculatedName_" + columnId);
            if (columnName != null) {
              String columnValue=request.getParameter("calculatedValue_" + columnId);
              report.addCalculatedColumn(columnName,columnValue);
            }
 else             log.warn("Cannot determine column type for column: " + columnId);
          }
        }
      }
    }
    String saveAsNew=ServletRequestUtils.getStringParameter(request,"saveAsNew","");
    if (!saveAsNew.equals(""))     report.setReportObjectId(null);
    Context.getReportService().updateReportObject(report);
    String action=ServletRequestUtils.getRequiredStringParameter(request,"action");
    MessageSourceAccessor msa=getMessageSourceAccessor();
    if (action.equals(msa.getMessage("DataExport.save"))) {
      view=getSuccessView();
      httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"DataExport.saved");
    }
 else {
      view=request.getContextPath() + "/dataExportServlet?dataExportId=" + report.getReportObjectId();
    }
  }
  return new ModelAndView(new RedirectView(view));
}
