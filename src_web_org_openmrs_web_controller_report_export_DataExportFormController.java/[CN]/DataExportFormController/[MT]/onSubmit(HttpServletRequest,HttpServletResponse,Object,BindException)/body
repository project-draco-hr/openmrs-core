{
  HttpSession httpSession=request.getSession();
  Context context=(Context)httpSession.getAttribute(WebConstants.OPENMRS_CONTEXT_HTTPSESSION_ATTR);
  String view=getFormView();
  if (context != null && context.isAuthenticated()) {
    DataExportReportObject report=(DataExportReportObject)obj;
    String[] patientIds=request.getParameterValues("patientId");
    report.setPatientIds(new Vector<Integer>());
    if (patientIds != null)     for (    String patientId : patientIds)     if (patientId != null && !patientId.equals(""))     report.addPatientId(Integer.valueOf(patientId));
    Integer location=RequestUtils.getIntParameter(request,"location",0);
    if (location > 0)     report.setLocation(context.getPatientService().getLocation(location));
    String[] columnIds=request.getParameterValues("columnId");
    report.setColumns(new Vector<ExportColumn>());
    if (columnIds != null) {
      for (      String columnId : columnIds) {
        String columnName=request.getParameter("simpleName_" + columnId);
        if (columnName != null)         report.addSimpleColumn(columnName,request.getParameter("simpleValue_" + columnId));
 else {
          columnName=request.getParameter("conceptColumnName_" + columnId);
          if (columnName != null) {
            String modifier=request.getParameter("conceptModifier_" + columnId);
            String conceptName=request.getParameter("conceptName_" + columnId);
            String[] extras=request.getParameterValues("conceptExtra_" + columnId);
            report.addConceptColumn(columnName,modifier,conceptName,extras);
          }
 else {
            columnName=request.getParameter("calculatedName_" + columnId);
            if (columnName != null) {
              String columnValue=request.getParameter("calculatedValue_" + columnId);
              report.addCalculatedColumn(columnName,columnValue);
            }
 else             log.warn("Cannot determine column type for column: " + columnId);
          }
        }
      }
    }
    String saveAsNew=RequestUtils.getStringParameter(request,"saveAsNew","");
    if (!saveAsNew.equals(""))     report.setReportObjectId(null);
    context.getReportService().updateReportObject(report);
    String action=RequestUtils.getRequiredStringParameter(request,"action");
    MessageSourceAccessor msa=getMessageSourceAccessor();
    if (action.equals(msa.getMessage("DataExport.save"))) {
      view=getSuccessView();
      httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"DataExport.saved");
    }
 else {
      view=request.getContextPath() + "/dataExportServlet?dataExportId=" + report.getReportObjectId();
    }
  }
  return new ModelAndView(new RedirectView(view));
}
