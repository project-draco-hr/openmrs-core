{
  HttpSession httpSession=request.getSession();
  Context context=(Context)httpSession.getAttribute(WebConstants.OPENMRS_CONTEXT_HTTPSESSION_ATTR);
  String view=getFormView();
  if (context != null && context.isAuthenticated()) {
    Obs obs=(Obs)obj;
    obs=setObjects(obs,request);
    ObsService os=context.getObsService();
    if (obs.getObsId() == null)     os.createObs(obs);
 else {
      if (obs.isVoided()) {
        String reason=obs.getVoidReason();
        if (reason != null && reason.length() > 0)         reason+=", ";
        os.voidObs(obs,reason + request.getParameter("editReason"));
      }
 else {
        Integer oldObsId=obs.getObsId();
        context.endTransaction();
        context.startTransaction();
        obs.setObsId(null);
        obs.setCreator(context.getAuthenticatedUser());
        obs.setDateCreated(new Date());
        os.updateObs(obs);
        Integer newObsId=obs.getObsId();
        context.endTransaction();
        context.startTransaction();
        Obs oldObs=os.getObs(oldObsId);
        os.voidObs(oldObs,request.getParameter("editReason") + " (new obsId: " + newObsId+ ")");
      }
    }
    view=getSuccessView();
    httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Obs.saved");
    view=view + "?encounterId=" + obs.getEncounter().getEncounterId()+ "&phrase="+ request.getParameter("phrase");
  }
  return new ModelAndView(new RedirectView(view));
}
