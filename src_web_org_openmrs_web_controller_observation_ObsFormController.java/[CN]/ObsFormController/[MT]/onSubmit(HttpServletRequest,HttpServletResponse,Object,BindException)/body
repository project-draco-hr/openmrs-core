{
  HttpSession httpSession=request.getSession();
  if (Context.isAuthenticated()) {
    Obs obs=(Obs)obj;
    ObsService os=Context.getObsService();
    try {
      if (request.getParameter("saveObs") != null) {
        String reason=request.getParameter("editReason");
        if (obs.getObsId() != null && (reason == null || reason.length() == 0)) {
          errors.reject("editReason","Obs.edit.reason.empty");
          return showForm(request,response,errors);
        }
        if (obs.getConcept().isComplex()) {
          if (request instanceof MultipartHttpServletRequest) {
            MultipartHttpServletRequest multipartRequest=(MultipartHttpServletRequest)request;
            MultipartFile complexDataFile=multipartRequest.getFile("complexDataFile");
            if (complexDataFile != null && !complexDataFile.isEmpty()) {
              InputStream complexDataInputStream=complexDataFile.getInputStream();
              ComplexData complexData=new ComplexData(complexDataFile.getOriginalFilename(),complexDataInputStream);
              obs.setComplexData(complexData);
              os.saveObs(obs,reason);
              complexDataInputStream.close();
            }
          }
        }
 else {
          os.saveObs(obs,reason);
        }
        httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Obs.saved");
      }
 else       if (request.getParameter("voidObs") != null) {
        String voidReason=request.getParameter("voidReason");
        if (obs.getObsId() != null && (voidReason == null || voidReason.length() == 0)) {
          errors.reject("voidReason","Obs.void.reason.empty");
          return showForm(request,response,errors);
        }
        os.voidObs(obs,voidReason);
        httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Obs.voidedSuccessfully");
      }
 else       if (request.getParameter("unvoidObs") != null) {
        os.unvoidObs(obs);
        httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Obs.unvoidedSuccessfully");
      }
    }
 catch (    APIException e) {
      httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,e.getMessage());
      return showForm(request,response,errors);
    }
    if (obs.getEncounter() != null) {
      String view=getSuccessView() + "?encounterId=" + obs.getEncounter().getEncounterId()+ "&phrase="+ request.getParameter("phrase");
      return new ModelAndView(new RedirectView(view));
    }
  }
  return showForm(request,response,errors);
}
