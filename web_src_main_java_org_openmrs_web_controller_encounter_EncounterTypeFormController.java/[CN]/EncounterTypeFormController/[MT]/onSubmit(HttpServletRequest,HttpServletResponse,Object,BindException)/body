{
  HttpSession httpSession=request.getSession();
  String view=getFormView();
  if (Context.isAuthenticated()) {
    EncounterType encounterType=(EncounterType)obj;
    EncounterService es=Context.getEncounterService();
    try {
      if (request.getParameter("save") != null) {
        es.saveEncounterType(encounterType);
        view=getSuccessView();
        httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"EncounterType.saved");
      }
 else       if (request.getParameter("retire") != null) {
        String retireReason=request.getParameter("retireReason");
        if (encounterType.getEncounterTypeId() != null && !(StringUtils.hasText(retireReason))) {
          errors.reject("retireReason","general.retiredReason.empty");
          return showForm(request,response,errors);
        }
        es.retireEncounterType(encounterType,retireReason);
        httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"EncounterType.retiredSuccessfully");
        view=getSuccessView();
      }
 else       if (request.getParameter("unretire") != null) {
        es.unretireEncounterType(encounterType);
        httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"EncounterType.unretiredSuccessfully");
        view=getSuccessView();
      }
 else       if (request.getParameter("purge") != null) {
        try {
          es.purgeEncounterType(encounterType);
          httpSession.setAttribute(WebConstants.OPENMRS_MSG_ATTR,"EncounterType.purgedSuccessfully");
          view=getSuccessView();
        }
 catch (        DataIntegrityViolationException e) {
          httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"error.object.inuse.cannot.purge");
          view="encounterType.form?encounterTypeId=" + encounterType.getEncounterTypeId();
        }
catch (        APIException e) {
          httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"error.general: " + e.getLocalizedMessage());
          view="encounterType.form?encounterTypeId=" + encounterType.getEncounterTypeId();
        }
      }
    }
 catch (    EncounterTypeLockedException e) {
      log.error("tried to save, retire, unretire or delete encounter type while encounter types were locked",e);
      httpSession.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"EncounterType.encounterTypes.locked");
      if (encounterType.getEncounterTypeId() != null) {
        view="encounterType.form?encounterTypeId=" + encounterType.getEncounterTypeId();
      }
    }
  }
  return new ModelAndView(new RedirectView(view));
}
