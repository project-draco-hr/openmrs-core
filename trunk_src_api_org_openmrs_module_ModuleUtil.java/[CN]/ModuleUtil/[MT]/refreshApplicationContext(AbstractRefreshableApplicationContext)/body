{
  OpenmrsClassLoader.saveState();
  ServiceContext.destroyInstance();
  try {
    ctx.stop();
    ctx.close();
  }
 catch (  Exception e) {
    log.warn("Exception while stopping and closing context: ",e);
  }
  OpenmrsClassLoader.destroyInstance();
  ctx.setClassLoader(OpenmrsClassLoader.getInstance());
  Thread.currentThread().setContextClassLoader(OpenmrsClassLoader.getInstance());
  ServiceContext.getInstance().startRefreshingContext();
  try {
    ctx.refresh();
  }
  finally {
    ServiceContext.getInstance().doneRefreshingContext();
  }
  ctx.setClassLoader(OpenmrsClassLoader.getInstance());
  Thread.currentThread().setContextClassLoader(OpenmrsClassLoader.getInstance());
  OpenmrsClassLoader.restoreState();
  if (log.isDebugEnabled())   log.debug("Reloading advice for all started modules: " + ModuleFactory.getStartedModules().size());
  for (  Module module : ModuleFactory.getStartedModules()) {
    ModuleFactory.loadAdvice(module);
  }
  return ctx;
}
