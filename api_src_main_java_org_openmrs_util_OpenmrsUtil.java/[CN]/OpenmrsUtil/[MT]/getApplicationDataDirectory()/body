{
  String filepath=null;
  if (System.getProperty("OPENMRS_APPLICATION_DATA_DIRECTORY") != null) {
    filepath=System.getProperty("OPENMRS_APPLICATION_DATA_DIRECTORY");
  }
 else {
    if (OpenmrsConstants.APPLICATION_DATA_DIRECTORY != null) {
      filepath=OpenmrsConstants.APPLICATION_DATA_DIRECTORY;
    }
 else {
      if (OpenmrsConstants.UNIX_BASED_OPERATING_SYSTEM) {
        filepath=System.getProperty("user.home") + File.separator + ".OpenMRS";
        if (!(new File(filepath)).canWrite()) {
          log.warn("Unable to write to users home dir, fallback to: " + OpenmrsConstants.APPLICATION_DATA_DIRECTORY_FALLBACK_UNIX);
          filepath=OpenmrsConstants.APPLICATION_DATA_DIRECTORY_FALLBACK_UNIX + File.separator + "OpenMRS";
        }
      }
 else {
        filepath=System.getProperty("user.home") + File.separator + "Application Data"+ File.separator+ "OpenMRS";
        if (!(new File(filepath)).canWrite()) {
          log.warn("Unable to write to users home dir, fallback to: " + OpenmrsConstants.APPLICATION_DATA_DIRECTORY_FALLBACK_WIN);
          filepath=OpenmrsConstants.APPLICATION_DATA_DIRECTORY_FALLBACK_WIN + File.separator + "OpenMRS";
        }
      }
      filepath=filepath + File.separator;
    }
  }
  File folder=new File(filepath);
  if (!folder.exists()) {
    folder.mkdirs();
  }
  return filepath;
}
