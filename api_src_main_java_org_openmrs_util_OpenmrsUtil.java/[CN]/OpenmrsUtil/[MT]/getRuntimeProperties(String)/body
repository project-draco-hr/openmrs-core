{
  if (applicationName == null)   applicationName="openmrs";
  String filepath=null;
  FileInputStream propertyStream=null;
  String filename=applicationName + "-runtime.properties";
  filepath=filename;
  log.debug("Attempting to load properties file in current directory: " + filepath);
  try {
    propertyStream=new FileInputStream(filepath);
  }
 catch (  FileNotFoundException e) {
    log.warn("Also unable to find a runtime properties file at " + new File(filepath).getAbsolutePath());
  }
  if (propertyStream == null) {
    String envVarName=applicationName.toUpperCase() + "_RUNTIME_PROPERTIES_FILE";
    filepath=System.getenv(envVarName);
    if (filepath != null) {
      log.debug("Atempting to load runtime properties from: " + filepath);
      try {
        propertyStream=new FileInputStream(filepath);
      }
 catch (      IOException e) {
        log.warn("Unable to load properties file with path: " + filepath + ". (derived from environment variable "+ envVarName+ ")",e);
      }
    }
 else {
      log.info("Couldn't find an environment variable named " + envVarName);
      if (log.isDebugEnabled())       log.debug("Available environment variables are named: " + System.getenv().keySet());
    }
  }
  if (propertyStream == null) {
    filepath=OpenmrsUtil.getApplicationDataDirectory() + filename;
    log.debug("Attempting to load property file from: " + filepath);
    try {
      propertyStream=new FileInputStream(filepath);
    }
 catch (    FileNotFoundException e) {
      log.warn("Unable to find properties file: " + filepath);
    }
  }
  try {
    if (propertyStream == null)     throw new IOException("Could not find a runtime properties file named " + filename + " in the OpenMRS application data directory, or the current directory");
    Properties props=new Properties();
    OpenmrsUtil.loadProperties(props,propertyStream);
    propertyStream.close();
    log.info("Using runtime properties file: " + filepath);
    return props;
  }
 catch (  Exception ex) {
    log.info("Got an error while attempting to load the runtime properties",ex);
    log.warn("Unable to find a runtime properties file. Initial setup is needed. View the webapp to run the setup wizard.");
    return null;
  }
}
