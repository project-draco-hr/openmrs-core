{
  Collection<Role> roles=user.getAllRoles();
  User authUser=Context.getAuthenticatedUser();
  List<String> requiredPrivs=new Vector<String>();
  for (  Role r : roles) {
    if (r.getRole().equals(RoleConstants.SUPERUSER) && !authUser.hasRole(RoleConstants.SUPERUSER))     throw new APIException("You must have the role '" + RoleConstants.SUPERUSER + "' in order to assign it.");
    if (r.getPrivileges() != null) {
      for (      Privilege p : r.getPrivileges())       if (!authUser.hasPrivilege(p.getPrivilege()))       requiredPrivs.add(p.getPrivilege());
    }
  }
  if (requiredPrivs.size() == 1) {
    throw new APIException("You must have privilege '" + requiredPrivs.get(0) + "' in order to assign it.");
  }
 else   if (requiredPrivs.size() > 1) {
    String txt="You must have the following privileges in order to assign them: ";
    for (    String s : requiredPrivs)     txt+=s + ", ";
    txt=txt.substring(0,txt.length() - 2);
    throw new APIException(txt);
  }
}
