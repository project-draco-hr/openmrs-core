{
  if (user.getUserId() == null) {
    Context.requirePrivilege(PrivilegeConstants.ADD_USERS);
  }
 else {
    Context.requirePrivilege(PrivilegeConstants.EDIT_USERS);
  }
  checkPrivileges(user);
  if (user.getUserId() == null && (password == null || password.length() < 1)) {
    throw new APIException("User.creating.password.required",(Object[])null);
  }
  if (hasDuplicateUsername(user)) {
    throw new DAOException("Username " + user.getUsername() + " or system id "+ user.getSystemId()+ " is already in use.");
  }
  if (user.getUserId() == null && password != null) {
    OpenmrsUtil.validatePassword(user.getUsername(),password,user.getSystemId());
  }
  Object[] params={Context.getLocale(),Context.getAuthenticatedUser()};
  Object key=(new DefaultKeyGenerator()).generate(null,null,params);
  cacheManager.getCache("userSearchLocales").evict(key);
  return dao.saveUser(user,password);
}
