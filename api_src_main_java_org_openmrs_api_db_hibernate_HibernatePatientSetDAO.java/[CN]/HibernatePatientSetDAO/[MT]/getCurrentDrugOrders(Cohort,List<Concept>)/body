{
  Map<Integer,List<DrugOrder>> ret=new HashMap<Integer,List<DrugOrder>>();
  Date now=new Date();
  Criteria criteria=sessionFactory.getCurrentSession().createCriteria(DrugOrder.class);
  criteria.setFetchMode("patient",FetchMode.JOIN);
  criteria.setCacheMode(CacheMode.IGNORE);
  if (patients != null)   criteria.add(Restrictions.in("patient.personId",patients.getMemberIds()));
  if (drugConcepts != null)   criteria.add(Restrictions.in("concept",drugConcepts));
  criteria.add(Restrictions.eq("voided",false));
  criteria.add(Restrictions.le("startDate",now));
  criteria.add(Restrictions.or(Restrictions.and(Restrictions.eq("discontinued",false),Restrictions.or(Restrictions.isNull("autoExpireDate"),Restrictions.gt("autoExpireDate",now))),Restrictions.and(Restrictions.eq("discontinued",true),Restrictions.gt("discontinuedDate",now))));
  criteria.addOrder(org.hibernate.criterion.Order.asc("startDate"));
  log.debug("criteria: " + criteria);
  List<DrugOrder> temp=criteria.list();
  for (  DrugOrder regimen : temp) {
    Integer ptId=regimen.getPatient().getPatientId();
    List<DrugOrder> list=ret.get(ptId);
    if (list == null) {
      list=new ArrayList<DrugOrder>();
      ret.put(ptId,list);
    }
    list.add(regimen);
  }
  return ret;
}
