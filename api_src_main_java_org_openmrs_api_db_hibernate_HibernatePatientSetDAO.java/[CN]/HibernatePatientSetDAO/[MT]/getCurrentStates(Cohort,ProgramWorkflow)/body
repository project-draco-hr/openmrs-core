{
  Map<Integer,PatientState> ret=new HashMap<Integer,PatientState>();
  Date now=new Date();
  Criteria criteria=sessionFactory.getCurrentSession().createCriteria(PatientState.class);
  criteria.setCacheMode(CacheMode.IGNORE);
  if (ps != null)   criteria.createCriteria("patientProgram").add(Restrictions.in("patient.personId",ps.getMemberIds()));
  criteria.createCriteria("state").add(Restrictions.eq("programWorkflow",wf));
  criteria.add(Restrictions.eq("voided",false));
  criteria.add(Restrictions.or(Restrictions.isNull("startDate"),Restrictions.le("startDate",now)));
  criteria.add(Restrictions.or(Restrictions.isNull("endDate"),Restrictions.ge("endDate",now)));
  log.debug("criteria: " + criteria);
  List<PatientState> temp=criteria.list();
  for (  PatientState state : temp) {
    Integer ptId=state.getPatientProgram().getPatient().getPatientId();
    ret.put(ptId,state);
  }
  return ret;
}
