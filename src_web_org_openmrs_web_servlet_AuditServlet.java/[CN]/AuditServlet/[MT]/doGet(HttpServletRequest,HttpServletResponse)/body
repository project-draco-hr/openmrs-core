{
  String audit=request.getParameter("audit");
  HttpSession session=request.getSession();
  Context context=(Context)session.getAttribute(WebConstants.OPENMRS_CONTEXT_HTTPSESSION_ATTR);
  if (audit == null || context == null || audit.length() == 0) {
    session.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"error.null");
    return;
  }
  AdministrationService as=context.getAdministrationService();
  PatientService ps=context.getPatientService();
  if (audit.equals("patientIdentifiers")) {
    PatientIdentifierType newType=ps.getPatientIdentifierType(new Integer("4"));
    List<PatientIdentifier> identifiers=new Vector<PatientIdentifier>();
    for (    PatientIdentifierType pit : ps.getPatientIdentifierTypes()) {
      if (pit.hasCheckDigit() && !pit.equals(newType)) {
        identifiers.addAll(ps.getPatientIdentifiers(pit));
      }
    }
    Integer count=0;
    for (    PatientIdentifier identifier : identifiers) {
      boolean updateNeeded=true;
      try {
        updateNeeded=!Helper.isValidCheckDigit(identifier.getIdentifier());
      }
 catch (      Exception e) {
        log.error("Patient #" + identifier.getPatient().getPatientId() + " Bad identifier: '"+ identifier.getIdentifier()+ "'");
      }
      if (updateNeeded) {
        identifier.setIdentifierType(newType);
        ps.updatePatientIdentifier(identifier);
        count++;
      }
    }
    session.setAttribute(WebConstants.OPENMRS_MSG_ATTR,count + " updates performed");
    response.sendRedirect(request.getContextPath() + "/admin/maintenance/auditPatientIdentifiers.htm");
    return;
  }
}
