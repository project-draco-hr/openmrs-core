{
  String audit=request.getParameter("audit");
  HttpSession session=request.getSession();
  if (audit == null || audit.length() == 0) {
    session.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"error.null");
    return;
  }
  PatientService ps=Context.getPatientService();
  if (audit.equals("patientIdentifiers")) {
    PatientIdentifierType newType=ps.getPatientIdentifierType(new Integer("4"));
    List<PatientIdentifier> identifiers=new Vector<PatientIdentifier>();
    for (    PatientIdentifierType pit : ps.getAllPatientIdentifierTypes()) {
      if (pit.hasValidator() && !pit.equals(newType)) {
        identifiers.addAll(ps.getPatientIdentifiers(null,Collections.singletonList(pit),null,null,null));
      }
    }
    Integer count=0;
    for (    PatientIdentifier identifier : identifiers) {
      boolean updateNeeded=true;
      try {
        IdentifierValidator piv=Context.getPatientService().getIdentifierValidator(identifier.getIdentifierType().getValidator());
        updateNeeded=!piv.isValid(identifier.getIdentifier());
      }
 catch (      Exception e) {
        log.error("Patient #" + identifier.getPatient().getPatientId() + " Bad identifier: '"+ identifier.getIdentifier()+ "'");
      }
      if (updateNeeded) {
        identifier.setIdentifierType(newType);
        ps.savePatient(identifier.getPatient());
        count++;
      }
    }
    session.setAttribute(WebConstants.OPENMRS_MSG_ATTR,count + " updates performed");
    response.sendRedirect(request.getContextPath() + "/admin/maintenance/auditPatientIdentifiers.htm");
    return;
  }
}
