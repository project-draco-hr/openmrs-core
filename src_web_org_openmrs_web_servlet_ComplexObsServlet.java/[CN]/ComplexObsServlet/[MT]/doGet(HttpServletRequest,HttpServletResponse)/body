{
  String obsId=request.getParameter("obsId");
  String view=request.getParameter("view");
  String viewType=request.getParameter("viewType");
  HttpSession session=request.getSession();
  if (obsId == null || obsId.length() == 0) {
    session.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"error.null");
    return;
  }
  if (!Context.hasPrivilege(OpenmrsConstants.PRIV_VIEW_OBS)) {
    session.setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"Privilege required: " + OpenmrsConstants.PRIV_VIEW_OBS);
    session.setAttribute(WebConstants.OPENMRS_LOGIN_REDIRECT_HTTPSESSION_ATTR,request.getRequestURI() + "?" + request.getQueryString());
    response.sendRedirect(request.getContextPath() + "/login.htm");
    return;
  }
  ObsService service=Context.getObsService();
  Obs complexObs=service.getObs(Integer.valueOf(obsId));
  String[] valComplex=complexObs.getValueComplex().split("\\|");
  String url=(valComplex.length < 2) ? valComplex[0] : valComplex[valComplex.length - 1];
  File file=new File(url);
  if (!file.exists()) {
    String fileName=file.getName();
    File dir=OpenmrsUtil.getDirectoryInApplicationDataDirectory(Context.getAdministrationService().getGlobalProperty(OpenmrsConstants.GLOBAL_PROPERTY_COMPLEX_OBS_DIR));
    file=new File(dir,fileName);
  }
  if (!file.exists()) {
    throw new ServletException("The file: " + file + " does not exist.");
  }
  String filename=response.encodeURL(url);
  if ("download".equals(viewType)) {
    response.setHeader("Content-Disposition","attachment; filename=" + filename);
    response.setHeader("Pragma","no-cache");
  }
  log.debug("Copying file stream to outputstream: " + file.getAbsolutePath());
  InputStream inStream=null;
  try {
    inStream=new FileInputStream(file);
    OpenmrsUtil.copyFile(inStream,response.getOutputStream());
  }
  finally {
    if (inStream != null)     try {
      inStream.close();
    }
 catch (    Exception e) {
    }
  }
}
