{
  @SuppressWarnings("unchecked") List<VisitAttributeType> attributeTypes=(List<VisitAttributeType>)model.get("attributeTypes");
  WebAttributeUtil.handleSubmittedAttributesForType(visit,result,VisitAttribute.class,request,attributeTypes);
  new VisitValidator().validate(visit,result);
  if (!result.hasErrors()) {
    try {
      Context.getVisitService().saveVisit(visit);
      if (log.isDebugEnabled())       log.debug("Saved visit: " + visit.toString());
      request.getSession().setAttribute(WebConstants.OPENMRS_MSG_ATTR,"Visit.saved");
      return "redirect:" + VISIT_FORM_URL + ".form?visitId="+ visit.getVisitId();
    }
 catch (    APIException e) {
      log.warn("Error while saving visit(s)",e);
      request.getSession().setAttribute(WebConstants.OPENMRS_ERROR_ATTR,"Visit.save.error");
    }
  }
  return VISIT_FORM;
}
